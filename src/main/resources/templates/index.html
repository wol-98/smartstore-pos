<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartStore Manager Suite</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script> 
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- üé® ENTERPRISE GLASS THEME --- */
        :root { 
            --primary: #7e22ce; --primary-dark: #6b21a8; --secondary: #10B981; --danger: #EF4444; 
            --warning: #F59E0B; --dark: #1e293b; 
            --card-bg: rgba(255, 255, 255, 0.85); --border: rgba(255, 255, 255, 0.6); 
            --text-main: #1f2937; --text-muted: #6b7280; --input-bg: rgba(255, 255, 255, 0.6);
        }
        body.dark-mode {
            --text-main: #f1f5f9; --text-muted: #94a3b8; --card-bg: rgba(30, 41, 59, 0.85); 
            --border: rgba(255, 255, 255, 0.1); --input-bg: rgba(15, 23, 42, 0.6); --dark: #f8fafc;
        }
        body { 
            font-family: 'Inter', sans-serif; padding: 20px; color: var(--text-main); margin: 0; 
            min-height: 100vh;
            display: flex; flex-direction: column; box-sizing: border-box; 
            background: linear-gradient(-45deg, #f3f4f6, #e9d5ff, #f3f4f6, #c4b5fd); background-size: 400% 400%;
            animation: gradientBG 15s ease infinite; transition: color 0.3s; 
        }
        body.dark-mode { background: linear-gradient(-45deg, #0f172a, #312e81, #1e1b4b, #312e81); background-size: 400% 400%; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .hidden { display: none !important; }
        .header-container { margin-bottom: 20px; flex-shrink: 0; }
        
        .card, .pos-billing-panel { 
            background: var(--card-bg); backdrop-filter: blur(12px); border: 1px solid var(--border); 
            border-radius: 16px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07); transition: transform 0.2s;
            margin-bottom: 0; 
        }
        .pos-billing-panel { display: flex; flex-direction: column; overflow: hidden; height: 100%; }
        
        /* RESPONSIVE GRID */
        .grid-dashboard-top { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 20px; }
        .grid-dashboard-mid { display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 20px; margin-bottom: 20px; } 
        .grid-dashboard-lower { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .grid-dashboard-bottom { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; } 
        .pos-container { display: grid; grid-template-columns: 1.2fr 1.8fr; gap: 20px; height: calc(100vh - 100px); overflow: hidden; }

        @media (max-width: 1024px) {
            .grid-dashboard-top { grid-template-columns: repeat(3, 1fr); }
            .grid-dashboard-mid { grid-template-columns: 1fr 1fr; }
            .grid-dashboard-lower, .grid-dashboard-bottom { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 768px) {
            body { padding: 10px; overflow-y: auto !important; height: auto; }
            .header-container { flex-direction: column; align-items: flex-start; gap: 10px; }
            .header-controls { flex-wrap: wrap; width: 100%; gap: 5px; }
            .grid-dashboard-top { grid-template-columns: 1fr 1fr; } 
            .grid-dashboard-mid, .grid-dashboard-lower, .grid-dashboard-bottom { grid-template-columns: 1fr; } 
            .pos-container { display: flex; flex-direction: column-reverse; height: auto; overflow: visible; }
            .pos-billing-panel, .pos-catalog-panel { height: auto; min-height: 500px; margin-bottom: 20px; }
            .catalog-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
        }

        .header-controls { display: flex; gap: 12px; align-items: center; background: var(--card-bg); padding: 8px 15px; border-radius: 12px; border: 1px solid var(--border); backdrop-filter: blur(12px); }
        .user-badge { background: rgba(126, 34, 206, 0.1); color: var(--primary); padding: 8px 15px; border-radius: 20px; font-weight: 700; font-size: 0.9em; border: 1px solid var(--border); }

        .billing-header { padding: 15px; background: var(--dark); color: white; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .billing-tools { padding: 10px; border-bottom: 1px solid var(--border); flex-shrink: 0; display: flex; gap: 8px; background: rgba(255,255,255,0.1); }
        
        .billing-cart-area { flex-grow: 1; overflow-y: auto; background: transparent; min-height: 0; }
        
        .billing-footer { padding: 20px; background: rgba(255,255,255,0.2); border-top: 1px solid var(--border); flex-shrink: 0; }
        .pos-catalog-panel { display: flex; flex-direction: column; overflow: hidden; height: 100%; }
        .catalog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; overflow-y: auto; padding-right: 5px; padding-bottom: 20px; }

        .stat-card { padding: 20px; position: relative; overflow: hidden; }
        .stat-card h2 { font-size: 2.2em; margin: 5px 0 0; color: var(--text-main); font-weight: 700; }
        .stat-card::before { content:''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: var(--primary); }
        .vip-scroll-area { max-height: 250px; overflow-y: auto; scrollbar-width: thin; }
        
        input, select, textarea { padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; width: 100%; box-sizing: border-box; background: var(--input-bg); color: var(--text-main); font-size: 0.95em; transition: 0.2s; outline: none; }
        input:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(126, 34, 206, 0.2); }
        
        button { padding: 10px 15px; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.9em; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: var(--primary); } .btn-success { background: var(--secondary); }
        .btn-glass { background: transparent; color: var(--text-main); border: 1px solid var(--border); width: auto; }
        .btn-sm { padding: 5px 10px; font-size: 0.8em; width: auto; }
        
        .product-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 15px; cursor: pointer; transition: 0.1s; display: flex; flex-direction: column; justify-content: space-between; height: 110px; user-select: none; position: relative; backdrop-filter: blur(5px); }
        .product-card:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .product-card h4 { margin: 0 0 5px 0; font-size: 0.95em; color: var(--text-main); line-height: 1.3; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .price { font-weight: 700; color: var(--primary); font-size: 1.1em; }
        .stock-badge { position: absolute; bottom: 12px; right: 12px; font-size: 0.75em; padding: 3px 8px; border-radius: 6px; background: var(--input-bg); color: var(--text-muted); font-weight: 700; border: 1px solid var(--border); }
        .stock-low { background: rgba(239, 68, 68, 0.1) !important; color: #dc2626 !important; border-color: rgba(239, 68, 68, 0.3) !important; }
        .stock-out { opacity: 0.5; pointer-events: none; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; background: rgba(0,0,0,0.05); font-size: 0.75em; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; z-index: 2; border-bottom: 1px solid var(--border); } 
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.9em; vertical-align: middle; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: 0.3s; backdrop-filter: blur(4px); }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal { background: var(--card-bg); width: 400px; padding: 25px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.2); transform: translateY(20px); transition: 0.3s; backdrop-filter: blur(12px); }
        .modal-overlay.open .modal { transform: translateY(0); }

        #undoToast { visibility: hidden; min-width: 300px; background-color: #1e293b; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 1em; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; }
        #undoToast.show { visibility: visible; animation: fadein 0.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        
        #chat-widget { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: none; flex-direction: column; align-items: flex-end; }
        #chat-btn { width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; font-size: 24px; border: none; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: 0.3s; display: flex; align-items: center; justify-content: center; }
        #chat-btn:hover { transform: scale(1.1); }
        #chat-window { width: 350px; height: 450px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); margin-bottom: 15px; display: none; flex-direction: column; backdrop-filter: blur(12px); overflow: hidden; }
        #chat-header { padding: 15px; background: var(--primary); color: white; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        #chat-body { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; font-size: 0.9em; }
        #chat-footer { padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 5px; }
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 80%; line-height: 1.4; }
        .msg-user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .msg-bot { align-self: flex-start; background: rgba(0,0,0,0.05); color: var(--text-main); border-bottom-left-radius: 2px; }

        /* --- PAYMENT STYLES --- */
        .payment-panel { background: rgba(0,0,0,0.05); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .card-input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card-input-grid label { font-size: 0.75em; font-weight: bold; color: var(--text-muted); margin-bottom: 3px; display: block; }
        
        .edc-screen { background: #000; color: #00ff00; font-family: 'Courier New', monospace; padding: 15px; border-radius: 8px; margin-top: 10px; text-align: center; border: 4px solid #333; box-shadow: inset 0 0 10px #000; }
        .input-group-real { margin-bottom: 10px; }
        .input-group-real label { display: block; font-size: 0.8em; font-weight: bold; margin-bottom: 5px; color: var(--text-muted); }
    </style>
</head>
<body id="mainBody">
    
    <div class="header-container flex-between">
        <div style="display:flex; align-items:center; gap:10px;">
            <h1 style="margin:0; font-size: 1.6em;"><i class="fa-solid fa-cube" style="color:var(--primary);"></i> SmartStore</h1>
        </div>
        
        <div class="header-controls">
            <button id="btnSupplier" onclick="toggleSection('supplierSection')" class="btn-glass hidden" title="Manage Suppliers">
                <i class="fa-solid fa-truck-field"></i> Suppliers
            </button>
            <a href="/kiosk.html" target="_blank" style="text-decoration:none;">
                <button class="btn-glass" title="Launch Kiosk Mode" style="border: 1px solid var(--primary); color: var(--primary);">
                    <i class="fa-solid fa-rocket"></i> Kiosk
                </button>
            </a>
            <button onclick="openFeedback()" class="btn-glass" title="Send Feedback"><i class="fa-regular fa-comment-dots"></i> Feedback</button>
            <div style="height: 30px; width: 1px; background: var(--border);"></div>
            <div id="adminControls" style="display:flex; gap:5px; align-items:center;">
                <input type="date" id="filterStart" onchange="loadDashboard()" style="border:none; width:auto; padding:5px; background: transparent; color: var(--text-main);">
                <span style="opacity:0.5;">|</span>
                <input type="date" id="filterEnd" onchange="loadDashboard()" style="border:none; width:auto; padding:5px; background: transparent; color: var(--text-main);">
            </div>
            <input type="file" id="excelInput" hidden accept=".xlsx, .xls" onchange="uploadExcel(this)">
            <button id="importBtn" onclick="document.getElementById('excelInput').click()" class="btn-primary" style="background:#f59e0b; width:auto;"><i class="fa-solid fa-file-import"></i> Import</button>
            <button id="exportBtn" onclick="downloadExcel()" class="btn-success" style="width:auto;"><i class="fa-solid fa-file-excel"></i> Export</button>
            <button onclick="toggleTheme()" class="btn-glass" style="width:auto;" title="Switch Theme"><i id="themeIcon" class="fa-solid fa-moon"></i></button>
            <div class="user-badge"><span id="currentUserDisplay">Loading...</span></div>
            <input type="hidden" id="cashierName"> 
            <a href="/logout"><button style="background:var(--dark); width:auto;"><i class="fa-solid fa-power-off"></i></button></a>
        </div>
    </div>

    <div id="chat-widget">
        <div id="chat-window">
            <div id="chat-header">
                <span>SmartStore Assistant</span>
                <button onclick="toggleChat()" style="background:transparent; border:none; color:white; cursor:pointer;">√ó</button>
            </div>
            <div id="chat-body">
                <div class="msg msg-bot">Hello! Ask me about profits, stock, or sales.</div>
            </div>
            <div id="chat-footer">
                <input type="text" id="chatInput" placeholder="Type a question..." onkeypress="handleChat(event)">
                <button onclick="sendChat()" class="btn-primary" style="width:auto; padding:8px 12px;"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
        <button id="chat-btn" onclick="toggleChat()"><i class="fa-solid fa-comment-dots"></i></button>
    </div>

    <div id="supplierSection" class="card hidden" style="margin-bottom:20px;">
        <div class="flex-between" style="margin-bottom:20px;">
            <h2 style="margin:0;">Supplier Master</h2>
            <button onclick="toggleSection('dashboardSection')" class="btn-glass" style="width:auto;">Close X</button>
        </div>
        <div style="background: rgba(0,0,0,0.03); padding:20px; border-radius:12px; border:1px solid var(--border); margin-bottom:20px;">
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:15px;">
                <input type="text" id="suppName" placeholder="Company Name (e.g. Apple India)">
                <input type="text" id="suppContact" placeholder="Contact Person">
                <input type="email" id="suppEmail" placeholder="Email (for POs)">
                <input type="text" id="suppPhone" placeholder="Phone">
            </div>
            <input type="text" id="suppAddress" placeholder="Full Address" style="margin-top:15px; width:100%;">
            <button onclick="saveSupplier()" class="btn-primary" style="margin-top:15px; width:100%;">
                <i class="fa-solid fa-plus"></i> Save Supplier
            </button>
        </div>
        <h3>Registered Vendors</h3>
        <table><thead><tr><th>ID</th><th>COMPANY</th><th>CONTACT</th><th>EMAIL</th><th>ACTIONS</th></tr></thead><tbody id="supplierTable"></tbody></table>
    </div>

    <div class="modal-overlay" id="feedbackModal">
        <div class="modal">
            <div class="flex-between" style="margin-bottom:15px;">
                <h3 style="margin:0;">Submit Feedback</h3>
                <button onclick="closeFeedback()" class="btn-glass" style="width:auto;">X</button>
            </div>
            <select id="feedbackCategory" style="margin-bottom:10px;" onchange="toggleProductLink()">
                <option value="General">General Suggestion</option>
                <option value="Stock">Stock Request</option>
                <option value="Bug">System Bug</option>
            </select>
            <input type="text" id="feedbackProductId" placeholder="Product ID (e.g. 101)" style="margin-bottom:10px; display:none;">
            <textarea id="feedbackText" rows="4" placeholder="Describe the issue..."></textarea>
            <button onclick="submitFeedback()" class="btn-primary" style="margin-top:15px;">Submit</button>
        </div>
    </div>

    <div id="dashboardSection" class="hidden">
        <div class="grid-dashboard-top">
            <div class="card stat-card"><h3>Total Revenue</h3><h2 id="statRevenue">‚Çπ0.00</h2><div style="font-size:0.8em; color:var(--secondary);">‚Üó Live Updates</div></div>
            <div class="card stat-card" style="border-left: 4px solid #10B981;"><h3>Net Profit</h3><h2 id="statProfit" style="color: #065F46;">‚Çπ0.00</h2><div style="font-size:0.8em; color:#10B981;"><i class="fa-solid fa-arrow-trend-up"></i> <span id="statMargin">0%</span> Margin</div></div>
            <div class="card stat-card"><h3>Total Orders</h3><h2 id="statOrders">0</h2><div style="font-size:0.8em; color:var(--primary);">üìã Processed</div></div>
            <div class="card stat-card"><h3>Stock Alerts</h3><h2 id="statLowStock" style="color:var(--danger);">0</h2><div style="font-size:0.8em; color:var(--danger);">‚ö† Action Needed</div></div>
            <div class="card stat-card" style="background: linear-gradient(135deg, #7e22ce 0%, #a855f7 100%); color: white;">
                <h3 style="color:white; opacity:0.9;">AI Forecast</h3><h2 id="statPrediction" style="color:white; margin-top:5px;">...</h2><div style="margin-top:5px; font-size:0.8em;"><i class="fa-solid fa-robot"></i> ML Powered</div>
            </div>
        </div>
        
        <div class="grid-dashboard-mid">
            <div class="card" style="display:flex; flex-direction:column;">
                <h3>Sales Activity</h3>
                <div style="flex-grow:1; position:relative; min-height:220px;">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
            <div class="card" style="display:flex; flex-direction:column;">
                <h3>üî• Best Sellers</h3>
                <div style="flex-grow:1; position:relative; min-height:220px; display:flex; justify-content:center;">
                    <canvas id="productsChart"></canvas>
                </div>
            </div>
            <div class="card" style="display:flex; flex-direction:column;">
                <h3>‚è∞ Peak Hours</h3>
                <div style="flex-grow:1; position:relative; min-height:220px;">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid-dashboard-lower">
            <div class="card">
                <h3>üßæ Live Transactions</h3>
                <div class="vip-scroll-area">
                    <table style="margin-top:10px; font-size:0.9em;">
                        <thead><tr><th>Time</th><th>Cashier</th><th style="text-align:right;">Amt</th></tr></thead>
                        <tbody id="transactionTable"><tr><td colspan="3" style="text-align:center;">Waiting...</td></tr></tbody>
                    </table>
                </div>
            </div>
            <div class="card"><h3>üìä Categories</h3><div style="height:200px;"><canvas id="categoryChart"></canvas></div></div>
            <div class="card">
                <h3>ü•á Top Staff</h3>
                <div class="vip-scroll-area" id="staffList" style="margin-top:10px;"></div>
            </div>
        </div>

        <div class="grid-dashboard-bottom">
            <div class="card">
                <div class="flex-between"><h3>Admin Inbox</h3><button onclick="loadFeedback()" class="btn-sm btn-glass"><i class="fa-solid fa-rotate"></i></button></div>
                <div class="vip-scroll-area"><table style="margin-top:10px;"><thead><tr><th>User</th><th>Msg</th><th>Action</th></tr></thead><tbody id="feedbackTable"></tbody></table></div>
            </div>
            <div class="card"><h3>üèÜ VIP Customers</h3><div class="vip-scroll-area"><table style="margin-top:10px;"><tbody id="vipTable"></tbody></table></div></div>
            <div class="card" style="display:flex; flex-direction:column; justify-content:space-between;">
                <div style="margin-bottom:15px;">
                    <div class="flex-between" style="margin-bottom:5px;">
                        <span style="font-weight:600; color:var(--text-muted); font-size:0.9em;">Daily Goal</span>
                        <span id="targetText" style="font-weight:bold; color:var(--primary);">0%</span>
                    </div>
                    <div style="height:8px; background:rgba(0,0,0,0.1); border-radius:5px; overflow:hidden;">
                        <div id="targetBar" style="height:100%; width:0%; background: linear-gradient(90deg, #10B981, #3B82F6); border-radius:5px; transition: width 1s;"></div>
                    </div>
                    <div id="targetValue" style="text-align:right; font-size:0.8em; margin-top:3px; color:var(--text-muted);">‚Çπ0 / ‚Çπ0</div>
                </div>
                <div>
                    <h4 style="margin:0 0 5px 0; font-size:0.9em; color:var(--text-muted);">üí≥ Payment Methods</h4>
                    <div style="height:110px; display:flex; justify-content:center;">
                        <canvas id="paymentChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="undoToast"><span>üóëÔ∏è Product Deleted</span><button onclick="undoDelete()" style="background: transparent; border: 1px solid #777; padding: 5px 10px; font-size: 0.9em; margin-left: 10px; color: #F59E0B;">UNDO</button></div>

    <div id="aiToast" style="visibility: hidden; min-width: 350px; background: linear-gradient(135deg, #6366f1, #a855f7); color: #fff; text-align: left; border-radius: 12px; padding: 15px; position: fixed; z-index: 200; left: 50%; top: -100px; transform: translateX(-50%); box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4); display: flex; align-items: center; gap: 15px; transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 50%;">
            <i class="fa-solid fa-robot" style="font-size: 1.5em;"></i>
        </div>
        <div>
            <div style="font-size: 0.8em; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; font-weight: bold;">Smart Suggestion</div>
            <div id="aiMsg" style="font-weight: 600; font-size: 1.1em;">Try adding a Charger?</div>
        </div>
    </div>

    <div class="grid-main" style="margin-top: 25px;">
        <div class="card hidden" id="inventorySection">
            <div class="flex-between" style="margin-bottom:20px;">
                <h2 style="margin:0;">Inventory Master</h2>
                <input type="text" id="inventorySearch" placeholder="Search products..." onkeyup="filterInventory()" style="width:300px;">
            </div>
            <input type="hidden" id="prodId"> 
            <div style="background: rgba(0,0,0,0.03); padding:20px; border-radius:12px; border:1px solid var(--border); margin-bottom:20px;">
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:15px;">
                    <input type="text" id="prodName" placeholder="Name" onkeyup="detectProductDetails()">
                    <input type="text" id="prodBrand" placeholder="Brand">
                    <input type="text" id="prodCategory" placeholder="Category">
                </div>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:15px;">
                    <input type="number" id="prodBuyingPrice" placeholder="Buying Price (Cost) ‚Çπ">
                    <input type="number" id="prodSellingPrice" placeholder="Selling Price (Retail) ‚Çπ">
                    <input type="number" id="prodStock" placeholder="Stock">
                </div>
                <div style="margin-bottom:15px;">
                    <label style="font-size:0.8em; color:var(--text-muted); font-weight:bold;">Primary Supplier:</label>
                    <select id="prodSupplier"><option value="">Select Supplier</option></select>
                </div>
                <button id="saveBtn" class="btn-primary" onclick="saveProduct()" style="margin-top:10px; padding: 15px; font-size:1.1em; width:100%;"><i class="fa-solid fa-plus"></i> Add to Inventory</button>
                <button id="cancelBtn" onclick="resetForm()" class="hidden" style="margin-top:10px; background:#6b7280; width:100%;">Cancel Edit</button>
            </div>
            <table>
                <thead><tr><th>ID</th><th>PRODUCT</th><th>BUYING PRICE</th><th>SELLING PRICE</th><th>STOCK</th><th style="text-align:right;">ACTIONS</th></tr></thead>
                <tbody id="inventoryTable"></tbody>
            </table>
        </div>

        <div id="billingSection" class="pos-container hidden">
            <div class="pos-billing-panel">
                <div class="billing-header"><div style="font-weight:700; font-size:1.1em;"><i class="fa-solid fa-cash-register"></i> POS Terminal</div><div id="posDateDisplay" style="font-size:0.8em; opacity:0.8; background:rgba(255,255,255,0.2); padding:3px 8px; border-radius:12px;"></div></div>
                <div class="billing-tools"><button onclick="toggleScanner()" style="background:#8B5CF6; padding:10px; font-size:0.9em; width:100%;"><i class="fa-solid fa-qrcode"></i> Scan QR</button><button onclick="clearCart()" style="background:#fee2e2; color:#ef4444; width:auto; padding:10px;"><i class="fa-solid fa-trash"></i></button></div>
                <div id="reader" style="display:none; overflow:hidden; position:relative; background:black;"><button onclick="toggleScanner()" style="position:absolute; top:5px; right:5px; background:red; color:white; z-index:100; width:auto; padding:5px 10px; border-radius:4px;">Close X</button></div>
                <div class="billing-cart-area"><table style="margin:0;"><thead><tr><th>ITEM</th><th style="text-align:center;">QTY</th><th style="text-align:right;">TOTAL</th><th></th></tr></thead><tbody id="cartTable"></tbody></table></div>
                
                <div class="billing-footer">
                    <div style="background:rgba(0,0,0,0.05); padding:10px; border-radius:8px; margin-bottom:15px;">
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <input type="text" id="couponCode" placeholder="Promo Code..." style="margin:0; text-transform:uppercase;">
                            <button onclick="applyCoupon()" class="btn-glass" style="width:auto; font-size:0.8em;">Apply</button>
                        </div>
                        <div id="couponMsg" style="font-size:0.75em; min-height:15px;"></div>
                    </div>

                    <div style="margin-bottom:15px;">
                        <div class="flex-between" style="font-size:0.9em; color:var(--text-muted); margin-bottom:2px;"><span>Subtotal</span><span>‚Çπ<span id="cartSubtotal">0.00</span></span></div>
                        <div class="flex-between" style="font-size:0.9em; color:var(--secondary); margin-bottom:5px;"><span>Discount</span><span>- ‚Çπ<span id="cartDiscount">0.00</span></span></div>
                        <div class="flex-between"><span style="color:var(--text-main); font-weight:700; font-size:1.1em;">Grand Total</span><span style="font-size:1.8em; font-weight:800; color:var(--text-main);">‚Çπ<span id="cartTotal">0.00</span></span></div>
                    </div>

                    <label style="font-size:0.8em; color:var(--text-muted); font-weight:600;">Customer Details</label>
                    <div style="display:flex; gap:10px; margin-bottom:15px;"><input type="email" id="custEmail" placeholder="Email (For Invoice)" style="margin:0; width:50%;"><input type="text" id="custPhone" placeholder="Phone (Loyalty)" style="margin:0; width:50%;"></div>
                    
                    <div style="margin-bottom:15px;">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                            <select id="payMethod" onchange="togglePaymentInterface()">
                                <option value="Cash">Cash</option>
                                <option value="UPI">UPI (Dynamic QR)</option>
                                <option value="Card">Card (External EDC)</option>
                            </select>
                            <select id="payStatus">
                                <option value="Paid">Paid</option>
                                <option value="Pending">Pending</option>
                            </select>
                        </div>
                    
                        <div id="cardInterface" class="payment-panel hidden">
                            <div class="flex-between" style="margin-bottom:10px;">
                                <div style="font-size:0.9em; font-weight:bold; color:var(--primary);"><i class="fa-solid fa-credit-card"></i> External EDC</div>
                                <div style="font-size:0.8em; color:var(--text-muted);">Swipe Card on Machine</div>
                            </div>
                            <div class="edc-screen">
                                <div style="font-size:0.8em;">AMOUNT TO SWIPE</div>
                                <div style="font-size:1.4em; font-weight:bold;">INR <span id="edcAmountDisplay">0.00</span></div>
                                <div style="font-size:0.7em; margin-top:5px;">WAITING FOR CARD...</div>
                            </div>
                            <div style="margin-top:15px;" class="input-group-real">
                                <label>AUTH CODE / REF NO. (From Charge Slip)</label>
                                <input type="text" id="cardAuthCode" placeholder="e.g. 082412" style="font-family:monospace; letter-spacing:2px;">
                            </div>
                        </div>
                    
                        <div id="upiInterface" class="payment-panel hidden" style="text-align:center;">
                            <label>Scan with Any App (GPay/PhonePe)</label>
                            <div id="qrPlaceholder" style="background:white; padding:10px; width:150px; margin:10px auto; border-radius:8px;">
                                <img id="upiQrCode" src="" alt="QR Code" style="width:100%; height:100%; display:none;">
                                <div id="qrLoader" style="padding:40px;"><i class="fa-solid fa-spinner fa-spin fa-2x" style="color:var(--primary);"></i></div>
                            </div>
                            <div style="font-size:0.8em; color:var(--text-muted);">Merchant: SmartStore Inc</div>
                            <div style="font-weight:bold; font-size:1.1em; margin-bottom:5px;">‚Çπ<span id="upiAmountDisplay">0.00</span></div>
                        </div>
                    </div>

                    <button id="btnCheckout" class="btn-success" onclick="checkout()" style="padding:15px; font-size:1.1em; width:100%;">Complete Transaction <i class="fa-solid fa-arrow-right"></i></button>
                    
                    <div id="postSale" class="success-box hidden">
                        <div class="success-icon"><i class="fa-solid fa-check" style="color:var(--secondary); font-size:0.6em; background:#ecfdf5; padding:10px; border-radius:50%;"></i></div>
                        <h3 style="color:#065f46; margin:0 0 10px 0; font-weight:800;">Sale Confirmed!</h3>
                        <div style="display:flex; gap:5px; margin-bottom:10px;"><input type="email" id="shareEmail" placeholder="Confirm Email..." style="border:1px solid #d1d5db; padding:8px;"><button onclick="shareReceipt(event)" style="background:var(--primary); width:auto; padding:8px 15px;"><i class="fa-solid fa-paper-plane"></i></button></div>
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
                            <button onclick="downloadReceipt()" style="background:#15803d; font-size:0.9em; padding:10px;"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                            <button onclick="printThermal()" style="background:#1e293b; font-size:0.9em; padding:10px;"><i class="fa-solid fa-print"></i> Thermal</button>
                            <button onclick="startNewSale()" style="background:#4b5563; font-size:0.9em; padding:10px;">New</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="pos-catalog-panel">
                <div class="flex-between" style="margin-bottom:15px;"><h2 style="margin:0; font-size:1.3em;">Product Catalog</h2><input type="text" id="posSearch" placeholder="üîç Search item..." onkeyup="renderCatalog()" style="width:50%;"></div>
                <div class="flex-between" style="margin-bottom:10px; background:rgba(0,0,0,0.05); padding:8px; border-radius:8px;"><span style="font-weight:600; font-size:0.9em; color:var(--text-main);">‚ö° Bulk Mode:</span><div style="display:flex; align-items:center; gap:5px;"><label style="font-size:0.8em; color:var(--text-main);">Qty:</label><input type="number" id="bulkQty" value="1" min="1" style="width:60px; padding:5px; text-align:center; font-weight:bold;"></div></div>
                <div id="productGrid" class="catalog-grid"></div>
            </div>
        </div>
    </div>

    <script>
            const API = '/api'; 
            let products = [], cart = [], lastSaleId = null, html5QrcodeScanner = null;
            let lastReceiptData = null; 

            const MERCHANT_VPA = "smartstore-demo@upi"; 
            
            let deleteTimeout = null; 
            let productToDelete = null;
            let chartInstances = {};
            let discountRate = 0;
            const valid_coupons = ['raphael15', 'ian15', 'matty15'];

            function playBeep() { 
                const ctx = new (window.AudioContext || window.webkitAudioContext)(); 
                const osc = ctx.createOscillator(); 
                const g = ctx.createGain(); 
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, ctx.currentTime); g.gain.setValueAtTime(0.05, ctx.currentTime); 
                osc.connect(g); g.connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime + 0.1); 
            }

            document.addEventListener('DOMContentLoaded', () => { 
                loadCurrentUser(); 
                document.getElementById('posDateDisplay').innerText = new Date().toLocaleDateString(); 
                applySavedTheme(); 
            });

            // --- ü§ñ NEW: AI Cross-Sell Logic (Triggered on Add to Cart) ---
            function checkAiRecommendations(productId) {
                // 1. Call your Java Recommendation Controller
                fetch(`${API}/recommendations/${productId}`)
                    .then(r => r.json())
                    .then(recs => {
                        // 2. Check if the AI returned any suggestions (Plan A/B/C)
                        if (recs && recs.length > 0) {
                            const topRec = recs[0]; // Take the #1 suggestion
                            
                            const toast = document.getElementById('aiToast');
                            const msg = document.getElementById('aiMsg');
                            
                            // 3. Update UI Text
                            msg.innerHTML = `Customer might need <b>${topRec.name}</b>!`;
                            
                            // 4. Show Animation (Slide Down)
                            toast.style.visibility = "visible";
                            toast.style.top = "30px"; 
                            
                            // 5. Hide automatically after 5 seconds
                            setTimeout(() => {
                                toast.style.top = "-100px";
                                setTimeout(() => { toast.style.visibility = "hidden"; }, 500);
                            }, 5000);
                        }
                    })
                    .catch(e => console.log("AI Brain Offline:", e));
            }

            // --- USER & AUTH ---
            function loadCurrentUser(){ 
                fetch('/api/me').then(r => r.json()).then(d => { 
                    document.getElementById('currentUserDisplay').innerText = d.username + " (" + (d.role || 'Staff') + ")"; 
                    document.getElementById('cashierName').value = d.username; 
                    
                    if(d.role === 'ADMIN'){ 
                        document.getElementById('mainBody').classList.add('admin-view'); 
                        document.getElementById('dashboardSection').classList.remove('hidden'); 
                        document.getElementById('inventorySection').classList.remove('hidden'); 
                        
                        const btnSupplier = document.getElementById('btnSupplier');
                        if(btnSupplier) btnSupplier.classList.remove('hidden');

                        document.getElementById('chat-widget').style.display = 'flex';
                        
                        // 1. Load Data Immediately
                        loadDashboard(); 
                        loadInventory(); 
                        loadFeedback(); 
                        loadSuppliers();

                        // ‚ö° 2. THIS IS THE FIX: Auto-Refresh every 1 min
                        // This makes the "Total Orders" and "Live Transactions" update automatically
                        setInterval(loadDashboard, 60000); 

                    } else { 
                        // ... (Staff logic stays the same) ...
                        document.getElementById('mainBody').classList.remove('admin-view'); 
                        document.getElementById('billingSection').classList.remove('hidden'); 
                        
                        const adminControls = document.getElementById('adminControls');
                        if(adminControls) adminControls.remove(); 
                        const exportBtn = document.getElementById('exportBtn');
                        if(exportBtn) exportBtn.remove();
                        const importBtn = document.getElementById('importBtn');
                        if(importBtn) importBtn.remove();
                        
                        const btnSupplier = document.getElementById('btnSupplier');
                        if(btnSupplier) btnSupplier.classList.add('hidden');

                        loadInventory(); 
                    } 
                }); 
            }

            function toggleSection(id) { 
                ['dashboardSection', 'inventorySection', 'supplierSection'].forEach(s => document.getElementById(s).classList.add('hidden')); 
                document.getElementById(id).classList.remove('hidden'); 
                if(id === 'dashboardSection' || id === 'inventorySection') { 
                    document.getElementById('dashboardSection').classList.remove('hidden'); 
                    document.getElementById('inventorySection').classList.remove('hidden'); 
                } 
            }
            function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); updateThemeIcon(); }
            function applySavedTheme() { if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode'); updateThemeIcon(); }
            function updateThemeIcon() { const icon = document.getElementById('themeIcon'); if (document.body.classList.contains('dark-mode')) { icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); icon.style.color = "#F59E0B"; } else { icon.classList.remove('fa-sun'); icon.classList.add('fa-moon'); icon.style.color = ""; } }
            function toggleChat() { const win = document.getElementById('chat-window'); win.style.display = (win.style.display === 'flex') ? 'none' : 'flex'; }
            function handleChat(e) { if (e.key === 'Enter') sendChat(); }
            function sendChat() { const input = document.getElementById('chatInput'); const msg = input.value; if (!msg) return; addMsg(msg, 'user'); input.value = ''; fetch(`${API}/chat`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question: msg }) }).then(r => r.json()).then(d => addMsg(d.answer, 'bot')).catch(() => addMsg("Sorry, I'm sleeping right now. üò¥", 'bot')); }
            function addMsg(text, type) { const body = document.getElementById('chat-body'); const div = document.createElement('div'); div.className = `msg msg-${type}`; div.innerText = text; body.appendChild(div); body.scrollTop = body.scrollHeight; }

            // --- DASHBOARD ---
            function loadDashboard(){ 
                let start = document.getElementById('filterStart').value; let end = document.getElementById('filterEnd').value;
                if (!start || !end) { const today = new Date(); start = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0]; end = today.toISOString().split('T')[0]; document.getElementById('filterStart').value = start; document.getElementById('filterEnd').value = end; }
                fetch(`${API}/dashboard/stats?startDate=${start}&endDate=${end}&t=${new Date().getTime()}`).then(r => r.json()).then(s => { 
                    document.getElementById('statRevenue').innerText = '‚Çπ' + (s.totalRevenue || 0).toFixed(2); 
                    document.getElementById('statOrders').innerHTML = `${s.totalOrders || 0} <span style="font-size:0.5em; display:block; opacity:0.7;">Lifetime: #${s.lifetimeOrders || 0}</span>`;
                    document.getElementById('statLowStock').innerText = s.lowStockCount || 0; 
                    document.getElementById('statProfit').innerText = '‚Çπ' + (s.totalProfit || 0).toFixed(2);
                    document.getElementById('statMargin').innerText = (s.profitMargin || 0).toFixed(1) + '%';
                    const target = s.dailyTarget || 20000; const current = s.totalRevenue || 0; let percent = 0; if(target > 0) percent = Math.round((current / target) * 100); if(percent > 100) percent = 100;
                    document.getElementById('targetText').innerText = percent + "%"; document.getElementById('targetBar').style.width = percent + "%"; document.getElementById('targetValue').innerText = `‚Çπ${Math.round(current)} / ‚Çπ${target}`;
                    ['salesChart','productsChart','categoryChart','paymentChart','hourlyChart'].forEach(id => { if(chartInstances[id]) chartInstances[id].destroy(); });
                    chartInstances['salesChart'] = new Chart(document.getElementById('salesChart'), { type: 'bar', data: { labels: ['Orders', 'Alerts'], datasets: [{ label: 'Count', data: [s.totalOrders || 0, s.lowStockCount || 0], backgroundColor: ['#7e22ce', '#EF4444'], borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
                    chartInstances['productsChart'] = new Chart(document.getElementById('productsChart'), { type: 'doughnut', data: { labels: Object.keys(s.topProducts || {}), datasets: [{ data: Object.values(s.topProducts || {}), backgroundColor: ['#3b82f6', '#10B981', '#F59E0B', '#EF4444', '#8b5cf6'], borderWidth: 2, borderColor: 'transparent' }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } } } });
                    const hours = s.hourlyTraffic || {}; chartInstances['hourlyChart'] = new Chart(document.getElementById('hourlyChart'), { type: 'line', data: { labels: Object.keys(hours).map(h=>h+":00"), datasets: [{ label: 'Visitors', data: Object.values(hours), borderColor: '#8B5CF6', backgroundColor: 'rgba(139, 92, 246, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } } });
                    chartInstances['categoryChart'] = new Chart(document.getElementById('categoryChart'), { type: 'bar', data: { labels: Object.keys(s.categoryRevenue || {}), datasets: [{ label: 'Revenue', data: Object.values(s.categoryRevenue || {}), backgroundColor: '#10B981', borderRadius: 4 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { display: false } } } } });
                    const payStats = s.paymentStats || { "CASH": 0 }; chartInstances['paymentChart'] = new Chart(document.getElementById('paymentChart'), { type: 'pie', data: { labels: Object.keys(payStats), datasets: [{ data: Object.values(payStats), backgroundColor: ['#F59E0B', '#10B981', '#6366F1'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 9 } } } } } });
                    document.getElementById('transactionTable').innerHTML = (s.recentSales || []).map(t => `<tr><td><small>${t.date.split('T')[1].substring(0,5)}</small></td><td>${t.cashierName||'-'}</td><td style="text-align:right;">‚Çπ${t.totalAmount}</td></tr>`).join('') || '<tr><td colspan="3" style="text-align:center;">No recent sales</td></tr>';
                    document.getElementById('staffList').innerHTML = Object.entries(s.staffPerformance || {}).map(([name, amt]) => `<div class="flex-between" style="margin-bottom:5px; padding:5px; border-bottom:1px solid rgba(0,0,0,0.05);"><span>üë§ ${name}</span><b style="color:var(--primary);">‚Çπ${amt}</b></div>`).join('');
                    document.getElementById('vipTable').innerHTML = (s.topCustomers || []).map((c, i) => `<tr><td style="padding:10px;"><b>${i + 1}. ${c.name}</b><br><small>${c.phone}</small></td><td style="text-align:right; color:#7e22ce;"><b>‚òÖ ${c.points}</b></td></tr>`).join('');
                });
                fetch(`${API}/dashboard/stats/ai`).then(r => r.json()).then(ai => { document.getElementById('statPrediction').innerText = (ai.predictedSales || 0) + " Units"; });
            }

            function loadInventory(){ fetch(`${API}/products`).then(r => r.json()).then(d => { products = d; requestAnimationFrame(() => renderCatalog()); if(!document.getElementById('inventorySection').classList.contains('hidden')){ setTimeout(renderInv, 50); } }); }
            
            function renderCatalog(){ 
                const t = document.getElementById('posSearch').value.toLowerCase(); 
                document.getElementById('productGrid').innerHTML = products.filter(p => (p.name && p.name.toLowerCase().includes(t)) || String(p.id).includes(t)).map(p => { 
                    let validStock = (p.stock === null || p.stock === undefined) ? 0 : p.stock; 
                    let validBrand = (p.brand && p.brand !== 'null') ? p.brand : ''; 
                    let c = 'product-card'; 
                    let s = 'stock-badge'; 
                    let action = `addToCart({id:${p.id}})`; 
                    if(validStock <= 5) s += ' stock-low'; 
                    if(validStock === 0){ s += ' stock-out'; c += ' opacity-50'; action = ''; } 
                    return `<div class="${c}" onclick="${action}">
                            <div><h4>${p.name}</h4><small>${validBrand}</small></div>
                            <div class="flex-between"><div class="price">‚Çπ${(p.sellingPrice || 0).toFixed(2)}</div><div class="${s}">${validStock} left</div></div>
                            </div>`; 
                }).join(''); 
            }

            function renderInv(){ 
                const t = document.getElementById('inventoryTable'); 
                if(t){ 
                    t.innerHTML = ''; 
                    products.forEach(p => { 
                        let s = p.stock <= 5 ? '<span style="color:red; font-weight:bold;">Low</span>' : '<span style="color:green; font-weight:bold;">Good</span>'; 
                        let b = p.stock <= 5 ? '#ef4444' : '#10b981'; 
                        let brand = p.brand; if(!brand || brand === 'null') brand = '-'; 
                        let cat = p.category; if(!cat || cat === 'null') cat = '-'; 
                        const meta = `${brand} ‚Ä¢ ${cat}`; 
                        t.innerHTML += `<tr data-id="${p.id}">
                            <td style="color:var(--primary); font-weight:bold;">PRD-${p.id}</td>
                            <td><b>${p.name}</b><br><small style="color:var(--text-muted);">${meta}</small></td>
                            <td style="color:var(--text-muted);">‚Çπ${(p.buyingPrice||0).toFixed(2)}</td>
                            <td><b>‚Çπ${(p.sellingPrice||0).toFixed(2)}</b></td>
                            <td><div class="flex-between" style="font-size:0.8em; margin-bottom:2px;"><span>${p.stock} units</span>${s}</div><div style="height:6px; background:rgba(0,0,0,0.1); border-radius:3px;"><div style="height:100%; width:${Math.min(p.stock,100)}%; background:${b}; border-radius:3px;"></div></div></td>
                            <td style="text-align:right; display:flex; gap:5px; justify-content:flex-end;">
                                <button onclick="editProduct(${p.id})" style="background:#f59e0b; width:auto; padding:5px 10px; font-size:0.8em;"><i class="fa-solid fa-pen"></i> Edit</button>
                                <button onclick="deleteProduct(${p.id})" style="background:#ef4444; width:auto; padding:5px 10px; font-size:0.8em;"><i class="fa-solid fa-trash"></i> Delete</button>
                            </td>
                        </tr>`; 
                    }); 
                } 
            }

            function addToCart(o){ 
                playBeep(); 
                let p = products.find(x => x.id === o.id); 
                let i = cart.find(x => x.productId === o.id); 
                let qty = parseInt(document.getElementById('bulkQty').value) || 1; 
                if(p.stock < (i ? i.quantity + qty : qty)) return alert("Out of Stock"); 
                if(i) i.quantity += qty; 
                else cart.push({productId:p.id, name:p.name, price:p.sellingPrice, quantity:qty}); 
                document.getElementById('bulkQty').value = 1; 
                renderCart(); 

                // üëá NEW: Trigger the AI Check (Plan A/B/C)!
                checkAiRecommendations(p.id);
            }

            function removeFromCart(i){ cart.splice(i, 1); renderCart(); }
            function clearCart(){ if(confirm("Clear?")) { cart = []; discountRate = 0; renderCart(); document.getElementById('couponCode').value = ''; document.getElementById('couponMsg').innerHTML = ''; } }
            function renderCart(){ 
                document.getElementById('cartTable').innerHTML = cart.map((i,x) => `<tr><td>${i.name}</td><td style="text-align:center;">${i.quantity}</td><td style="text-align:right;">‚Çπ${(i.price*i.quantity).toFixed(2)}</td><td onclick="removeFromCart(${x})" style="color:red; cursor:pointer; text-align:center;">√ó</td></tr>`).join(''); 
                const subtotal = cart.reduce((a,b) => a + (b.price * b.quantity), 0); 
                const discountAmount = subtotal * discountRate; 
                const total = subtotal - discountAmount; 
                document.getElementById('cartSubtotal').innerText = subtotal.toFixed(2); 
                document.getElementById('cartDiscount').innerText = discountAmount.toFixed(2); 
                document.getElementById('cartTotal').innerText = total.toFixed(2); 
                
                if(!document.getElementById('cardInterface').classList.contains('hidden')){
                    document.getElementById('edcAmountDisplay').innerText = total.toFixed(2);
                }
                if(!document.getElementById('upiInterface').classList.contains('hidden')){
                    document.getElementById('upiAmountDisplay').innerText = total.toFixed(2);
                    if(total > 0) generateRealUPIQr(total.toFixed(2));
                }
            }
            function applyCoupon() { const code = document.getElementById('couponCode').value.trim().toLowerCase(); const msg = document.getElementById('couponMsg'); if (valid_coupons.includes(code)) { discountRate = 0.15; msg.innerHTML = '<span style="color:#10B981; font-weight:bold;">‚úÖ 15% Discount Applied!</span>'; renderCart(); } else { discountRate = 0; msg.innerHTML = '<span style="color:#EF4444; font-weight:bold;">‚ùå Invalid Code</span>'; renderCart(); } }

            // --- REAL WORLD PAYMENT LOGIC ---
            function togglePaymentInterface() {
                const method = document.getElementById('payMethod').value;
                const cardPanel = document.getElementById('cardInterface');
                const upiPanel = document.getElementById('upiInterface');
                const totalAmount = document.getElementById('cartTotal').innerText;

                cardPanel.classList.add('hidden');
                upiPanel.classList.add('hidden');

                if (method === 'Card') {
                    cardPanel.classList.remove('hidden');
                    document.getElementById('edcAmountDisplay').innerText = totalAmount;
                    document.getElementById('cardAuthCode').focus();
                } 
                else if (method === 'UPI') {
                    upiPanel.classList.remove('hidden');
                    document.getElementById('upiAmountDisplay').innerText = totalAmount;
                    if(parseFloat(totalAmount) > 0) generateRealUPIQr(totalAmount);
                }
            }

            function generateRealUPIQr(amount) {
                const qrImg = document.getElementById('upiQrCode');
                const loader = document.getElementById('qrLoader');
                
                qrImg.style.display = 'none';
                loader.style.display = 'block';

                const upiLink = `upi://pay?pa=${MERCHANT_VPA}&pn=SmartStore&am=${amount}&cu=INR`;
                
                qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(upiLink)}`;
                
                qrImg.onload = () => {
                    loader.style.display = 'none';
                    qrImg.style.display = 'block';
                };
            }

            function checkout() { 
                if (!cart.length) return alert("Cart is empty!"); 
                const method = document.getElementById('payMethod').value;
                
                if (method === 'Card') {
                    const authCode = document.getElementById('cardAuthCode').value.trim();
                    if(authCode.length < 4) {
                        return alert("‚ùå TRANSACTION FAILED\nPlease enter the Auth Code/Ref No. from the Card Machine receipt.");
                    }
                }

                if (method === 'UPI') {
                    const status = document.getElementById('payStatus').value;
                    if (status !== 'Paid') {
                        if(!confirm("‚ö†Ô∏è Payment status is 'Pending'.\nDid you confirm the money reached your bank account?")) return;
                    }
                }

                const btn = document.getElementById('btnCheckout'); 
                const originalText = btn.innerText; 
                btn.innerText = 'Processing...'; 
                btn.disabled = true; 
                
                const cashier = document.getElementById('cashierName').value;
                const customer = document.getElementById('custPhone').value;
                const total = document.getElementById('cartTotal').innerText;

                fetch(`${API}/sales`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ 
                        items: cart, 
                        cashierName: cashier, 
                        customerPhone: customer, 
                        paymentMethod: method, 
                        status: document.getElementById('payStatus').value 
                    }) 
                })
                .then(async r => { if (!r.ok) throw new Error(await r.text()); return r.json(); })
                .then(d => { 
                    lastSaleId = d.id; 
                    lastReceiptData = {
                        id: d.id,
                        date: new Date().toLocaleString(),
                        items: [...cart],
                        total: total,
                        cashier: cashier,
                        customer: customer || "Walk-in"
                    };
                    document.getElementById('btnCheckout').classList.add('hidden'); 
                    document.getElementById('postSale').classList.remove('hidden'); 
                    
                    const shareInput = document.getElementById('shareEmail');
                    const custInput = document.getElementById('custEmail');
                    if (shareInput && custInput) {
                        shareInput.value = custInput.value;
                    }

                    loadInventory(); 
                    loadDashboard(); 
                })
                .catch(e => { 
                    alert("Failed: " + e.message); 
                    btn.innerText = originalText; 
                    btn.disabled = false; 
                }); 
            }
            
            function startNewSale(){ 
                cart=[]; discountRate=0; 
                document.getElementById('couponCode').value=''; 
                document.getElementById('couponMsg').innerHTML=''; 
                renderCart(); 
                document.getElementById('postSale').classList.add('hidden'); 
                document.getElementById('btnCheckout').classList.remove('hidden'); 
                document.getElementById('btnCheckout').innerText='Complete Transaction'; 
                document.getElementById('btnCheckout').disabled = false; 
                document.getElementById('shareEmail').value=''; 
                document.getElementById('custEmail').value=''; 
                document.getElementById('custPhone').value=''; 
                document.getElementById('cardAuthCode').value=''; 
                
                document.getElementById('payMethod').value = 'Cash';
                togglePaymentInterface();
            }

            function loadSuppliers() { fetch(`${API}/suppliers`).then(r => r.json()).then(d => { const t = document.getElementById('supplierTable'); t.innerHTML = d.map(s => `<tr><td>#${s.id}</td><td><b>${s.name}</b></td><td>${s.contactPerson||'-'}</td><td>${s.email||'-'}</td><td><button onclick="deleteSupplier(${s.id})" style="background:#ef4444; width:auto; padding:5px 10px; font-size:0.8em;">Delete</button></td></tr>`).join(''); const sel = document.getElementById('prodSupplier'); sel.innerHTML = '<option value="">-- Select Supplier --</option>' + d.map(s => `<option value="${s.id}">${s.name}</option>`).join(''); }); }
            function saveSupplier() { const data = { name: document.getElementById('suppName').value, contactPerson: document.getElementById('suppContact').value, email: document.getElementById('suppEmail').value, phone: document.getElementById('suppPhone').value, address: document.getElementById('suppAddress').value }; if(!data.name) return alert("Company Name is required"); fetch(`${API}/suppliers`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }).then(r => { alert("Supplier Saved!"); document.querySelectorAll('#supplierSection input').forEach(i => i.value = ''); loadSuppliers(); }); }
            function deleteSupplier(id) { if(confirm("Delete this supplier?")) { fetch(`${API}/suppliers/${id}`, { method: 'DELETE' }).then(loadSuppliers); } }
            function loadFeedback() { fetch(`${API}/feedback`).then(r => r.json()).then(data => { const t = document.getElementById('feedbackTable'); if(!data.length) { t.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:10px;">No messages.</td></tr>'; return; } t.innerHTML = data.map(f => { let action = ''; if(f.status === 'RESOLVED' || f.status.includes('APPROVED')) action = '<span style="color:green; font-weight:bold;">‚úî Done</span>'; else if(f.category === 'Stock' && f.linkedProductId) action = `<button onclick="approveStock(${f.id})" class="btn-sm" style="background:#10B981; color:white;">+10 Stock</button>`; else action = `<button onclick="resolveFeedback(${f.id})" class="btn-sm" style="background:#3b82f6; color:white;">Resolve</button>`; return `<tr><td style="padding:8px;"><small>${f.submittedAt.split('T')[0]}</small><br><b>${f.username}</b></td><td style="padding:8px;"><b>${f.category}</b><br>${f.message}</td><td style="padding:8px; text-align:right;">${action}</td></tr>`; }).join(''); }); }
            function resolveFeedback(id) { fetch(`${API}/feedback/${id}/resolve`, {method:'PUT'}).then(loadFeedback); }
            function approveStock(id) { fetch(`${API}/feedback/${id}/approve-stock`, {method:'PUT'}).then(() => { alert("Stock Added!"); loadFeedback(); loadInventory(); }); }
            
            function saveProduct() { 
                const id = document.getElementById('prodId').value; 
                const payload = { 
                    name: document.getElementById('prodName').value, 
                    brand: document.getElementById('prodBrand').value, 
                    category: document.getElementById('prodCategory').value, 
                    buyingPrice: parseFloat(document.getElementById('prodBuyingPrice').value), 
                    sellingPrice: parseFloat(document.getElementById('prodSellingPrice').value), 
                    supplierId: document.getElementById('prodSupplier').value || null, 
                    stock: parseInt(document.getElementById('prodStock').value) 
                }; 
                if (id) payload.id = id; 
                fetch(`${API}/products`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).then(() => { resetForm(); loadInventory(); }); 
            }

            function deleteProduct(id) { const row = document.querySelector(`tr[data-id="${id}"]`); if (row) { row.style.opacity = '0.3'; row.style.pointerEvents = 'none'; } productToDelete = id; document.getElementById('undoToast').className = "show"; deleteTimeout = setTimeout(() => { fetch(`${API}/products/${id}`,{method:'DELETE'}).then(loadInventory); document.getElementById('undoToast').className = ""; }, 4000); }
            function undoDelete() { clearTimeout(deleteTimeout); const row = document.querySelector(`tr[data-id="${productToDelete}"]`); if (row) { row.style.opacity = '1'; row.style.pointerEvents = 'auto'; } document.getElementById('undoToast').className = ""; }
            
            function editProduct(id) { 
                const p = products.find(x => x.id === id); 
                document.getElementById('prodId').value = p.id; 
                document.getElementById('prodName').value = p.name; 
                document.getElementById('prodBrand').value = p.brand; 
                document.getElementById('prodCategory').value = p.category; 
                document.getElementById('prodBuyingPrice').value = p.buyingPrice; 
                document.getElementById('prodSellingPrice').value = p.sellingPrice; 
                document.getElementById('prodStock').value = p.stock; 
                document.getElementById('prodSupplier').value = p.supplierId || ""; 
                document.getElementById('saveBtn').innerHTML = '<i class="fa-solid fa-check"></i> Update Product'; 
                document.getElementById('cancelBtn').classList.remove('hidden'); 
                
                document.getElementById('inventorySection').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            function resetForm() { document.querySelectorAll('#inventorySection input').forEach(i => i.value=''); document.getElementById('prodId').value = ''; document.getElementById('prodSupplier').value = ''; document.getElementById('saveBtn').innerHTML = '<i class="fa-solid fa-plus"></i> Add to Inventory'; document.getElementById('cancelBtn').classList.add('hidden'); }
            function toggleScanner(){ const r=document.getElementById('reader'); if(r.style.display==='none'){ r.style.display='block'; html5QrcodeScanner=new Html5QrcodeScanner("reader",{fps:10,qrbox:250}); html5QrcodeScanner.render(t=>{ let p=products.find(x=>x.name.toLowerCase()===t.toLowerCase()||x.id==t); if(p){ addToCart({id:p.id}); html5QrcodeScanner.pause(); setTimeout(()=>html5QrcodeScanner.resume(),1500); } }); } else { if(html5QrcodeScanner) html5QrcodeScanner.clear(); r.style.display='none'; } }
            function uploadExcel(input) { const fd=new FormData(); fd.append("file", input.files[0]); fetch(`${API}/products/upload`,{method:'POST',body:fd}).then(r=>r.text()).then(m=>{ alert(m); loadInventory(); }); }
            function downloadExcel() { window.location.href = `${API}/sales/export`; }
            function downloadReceipt(){ window.open(`/api/sales/${lastSaleId}/pdf`); }

            function shareReceipt(event){ 
                const e = document.getElementById('shareEmail').value; 
                if (!e) return alert("Enter email."); 

                const btn = event.currentTarget; 
                const originalContent = btn.innerHTML; 

                btn.disabled = true; 
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; 
                
                fetch(`${API}/sales/${lastSaleId}/share?email=${encodeURIComponent(e)}`, { method: 'POST' })
                    .then(r => {
                        if (r.ok) {
                            btn.style.background = '#10B981'; 
                            btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                            setTimeout(() => {
                               btn.style.background = 'var(--primary)'; 
                               btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
                               btn.disabled = false;
                            }, 3000);
                        } else {
                            alert("Failed to send email.");
                            btn.disabled = false;
                            btn.innerHTML = originalContent;
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        btn.disabled = false;
                        btn.innerHTML = originalContent;
                        alert("Network error.");
                    });
            }
            
            function printThermal() {
                if (!lastReceiptData) { alert("No receipt data found!"); return; }

                let itemsHtml = lastReceiptData.items.map(item => `
                    <tr>
                        <td style="text-align: left;">${item.name} <br> <small>x${item.quantity}</small></td>
                        <td style="text-align: right;">${(item.price * item.quantity).toFixed(2)}</td>
                    </tr>
                `).join('');

                let printWindow = window.open('', '_blank', 'width=300,height=600');
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>Receipt #${lastReceiptData.id}</title>
                        <style>
                            body { font-family: 'Courier New', monospace; margin: 0; padding: 5px; width: 280px; font-size: 12px; }
                            .text-center { text-align: center; }
                            .text-right { text-align: right; }
                            .bold { font-weight: bold; }
                            .line { border-bottom: 1px dashed #000; margin: 5px 0; }
                            table { width: 100%; border-collapse: collapse; }
                            td { vertical-align: top; }
                        </style>
                    </head>
                    <body>
                        <div class="text-center">
                            <div class="bold" style="font-size: 16px;">SMARTSTORE POS</div>
                            <div>Mumbai, India</div>
                            <div>Tel: 9876543210</div>
                        </div>
                        <div class="line"></div>
                        <div><strong>Receipt #:</strong> ${lastReceiptData.id}</div>
                        <div><strong>Date:</strong> ${lastReceiptData.date}</div>
                        <div><strong>Customer:</strong> ${lastReceiptData.customer}</div>
                        <div class="line"></div>
                        <table>${itemsHtml}</table>
                        <div class="line"></div>
                        <table>
                            <tr><td><strong>TOTAL</strong></td><td class="text-right bold" style="font-size: 14px;">‚Çπ${parseFloat(lastReceiptData.total).toFixed(2)}</td></tr>
                        </table>
                        <div class="line"></div>
                        <div class="text-center">Thank you for shopping!<br>www.smartstore.com</div>
                        <script>
                            window.onload = function() { window.print(); setTimeout(() => window.close(), 1000); };
                        <\/script>
                    </body>
                    </html>
                `);
                printWindow.document.close();
            }

            function convertNumberToWords(amount) { const words = ["Zero", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine", "Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen"]; const tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"]; if (amount < 20) return words[amount]; if (amount < 100) return tens[Math.floor(amount / 10)] + (amount % 10 ? " " + words[amount % 10] : ""); if (amount < 1000) return words[Math.floor(amount / 100)] + " Hundred" + (amount % 100 ? " and " + convertNumberToWords(amount % 100) : ""); return amount + ""; }
            function filterInventory() { const term = document.getElementById('inventorySearch').value.toLowerCase(); document.querySelectorAll('#inventoryTable tr').forEach(row => { row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none'; }); }
            function detectProductDetails() { const name = document.getElementById('prodName').value.toLowerCase(); const match = [{k:'iphone',b:'Apple',c:'Electronics'}, {k:'nike',b:'Nike',c:'Apparel'}].find(r => name.includes(r.k)); if(match) { document.getElementById('prodBrand').value = match.b; document.getElementById('prodCategory').value = match.c; } }
            function openFeedback() { document.getElementById('feedbackModal').classList.add('open'); }
            function closeFeedback() { document.getElementById('feedbackModal').classList.remove('open'); }
            function toggleProductLink() { document.getElementById('feedbackProductId').style.display = document.getElementById('feedbackCategory').value === 'Stock' ? 'block' : 'none'; }
            function submitFeedback() { const text = document.getElementById('feedbackText').value; const category = document.getElementById('feedbackCategory').value; const pid = document.getElementById('feedbackProductId').value; if(!text) return alert("Please enter some feedback!"); fetch(`${API}/feedback`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: text, category: category, productId: pid }) }).then(r => { if(r.ok) { alert("‚úÖ Feedback Sent!"); document.getElementById('feedbackText').value = ""; document.getElementById('feedbackProductId').value = ""; closeFeedback(); } else { alert("Error sending feedback."); } }); }
        </script>
</body>
</html>