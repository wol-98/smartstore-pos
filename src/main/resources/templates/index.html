<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SmartStore Manager Suite</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script> 
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- PRO THEME --- */
        :root { 
            --primary: #7e22ce; /* Purple */
            --primary-dark: #6b21a8;
            --secondary: #10B981; /* Green */
            --danger: #EF4444; 
            --warning: #F59E0B; 
            --dark: #1e293b; 
            --light: #f3f4f6; 
            --card-bg: #ffffff; 
            --border: #e5e7eb;
            --text-main: #1f2937;
            --text-muted: #6b7280;
        }

        /* DEFAULT BODY (POS MODE - LOCKED SCREEN) */
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--light); 
            padding: 20px; 
            color: var(--text-main); 
            margin: 0; 
            box-sizing: border-box; 
            
            /* Default: Lock screen for POS App feel */
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        /* üöÄ ADMIN OVERRIDE (UNLOCK SCROLL) */
        /* When class 'admin-view' is added, enable normal page scrolling */
        body.admin-view {
            height: auto !important;
            overflow-y: auto !important; /* Enable Global Scrollbar */
            display: block !important;
        }

        /* --- UTILS --- */
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .hidden { display: none !important; }
        .header-container { margin-bottom: 20px; flex-shrink: 0; }
        
        /* --- DASHBOARD GRID --- */
        .grid-dashboard-top { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
        .grid-dashboard-bottom { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        
        /* ADMIN MAIN CONTAINER FIX */
        .admin-view .grid-main { 
            display: block; 
            height: auto !important; /* Let it grow naturally */
            overflow: visible !important; /* No internal scrollbar */
            padding-bottom: 50px; 
        }

        /* --- üöÄ POS SPLIT LAYOUT --- */
        .pos-container { 
            display: grid; 
            grid-template-columns: 1.2fr 1.8fr; 
            gap: 20px; 
            height: calc(100vh - 100px); 
            overflow: hidden; 
        }

        .pos-billing-panel { display: flex; flex-direction: column; background: white; border-radius: 16px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); height: 100%; }
        .billing-header { padding: 15px; background: var(--dark); color: white; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .billing-tools { padding: 10px; border-bottom: 1px solid var(--border); flex-shrink: 0; display: flex; gap: 8px; background: #f9fafb; }
        .billing-cart-area { flex-grow: 1; overflow-y: auto; background: #fff; }
        .billing-footer { padding: 20px; background: #fff; border-top: 1px solid var(--border); flex-shrink: 0; }

        .pos-catalog-panel { display: flex; flex-direction: column; overflow: hidden; height: 100%; }
        .catalog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; overflow-y: auto; padding-right: 5px; padding-bottom: 20px; }

        /* --- CARDS & WIDGETS --- */
        .card { background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .stat-card h2 { font-size: 2.2em; margin: 5px 0 0; color: var(--dark); font-weight: 700; }
        .stat-card { position: relative; overflow: hidden; }
        .stat-card::before { content:''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: var(--primary); }
        
        input, select { padding: 12px; border: 1px solid var(--border); border-radius: 8px; width: 100%; box-sizing: border-box; background: #fff; font-size: 0.95em; transition: 0.2s; outline: none; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(126, 34, 206, 0.1); }

        button { padding: 12px; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; width: 100%; transition: 0.2s; font-size: 0.95em; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: var(--primary); } 
        .btn-success { background: var(--secondary); }
        
        .product-card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 15px; cursor: pointer; transition: 0.1s; display: flex; flex-direction: column; justify-content: space-between; height: 110px; user-select: none; position: relative; }
        .product-card:active { transform: scale(0.98); }
        .product-card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(126, 34, 206, 0.1); }
        .product-card h4 { margin: 0 0 5px 0; font-size: 0.95em; color: var(--dark); line-height: 1.3; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .price { font-weight: 700; color: var(--primary); font-size: 1.1em; }
        
        .stock-badge { position: absolute; bottom: 12px; right: 12px; font-size: 0.75em; padding: 3px 8px; border-radius: 6px; background: #f3f4f6; color: var(--text-muted); font-weight: 700; border: 1px solid var(--border); }
        .stock-low { background: #fee2e2; color: #dc2626; border-color: #fecaca; }
        .stock-out { opacity: 0.5; pointer-events: none; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; background: #f9fafb; font-size: 0.75em; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; z-index: 2; border-bottom: 1px solid var(--border); } 
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.9em; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }

        .success-box { background-color: #ecfdf5; border: 1px solid #6ee7b7; border-radius: 12px; padding: 20px; text-align: center; margin-top: 15px; animation: fadeIn 0.3s ease-in; }
        .success-icon { color: #10b981; font-size: 3em; margin-bottom: 10px; background: white; border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px auto; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .user-badge { background: #fff; border: 1px solid var(--border); padding: 8px 16px; border-radius: 30px; font-weight: 600; font-size: 0.9em; display: flex; align-items: center; gap: 8px; }

        #thermal-receipt { display: none; } 
        @media print { body * { visibility: hidden; } #thermal-receipt, #thermal-receipt * { visibility: visible; } #thermal-receipt { position: absolute; left: 0; top: 0; width: 100%; } @page { margin: 0; size: 80mm auto; } }
    </style>
</head>
<body id="mainBody">
    
    <div class="header-container flex-between">
        <div>
            <h1 style="margin:0; font-size: 1.6em;"><i class="fa-solid fa-cube" style="color:var(--primary);"></i> SmartStore</h1>
            <span style="color:var(--text-muted); font-size:0.9em;">Enterprise Management Suite</span>
        </div>
        
        <div style="display:flex; gap:10px; align-items:center;">
            <div id="adminControls" style="display:flex; gap:5px; align-items:center; background: #fff; padding: 5px; border-radius: 12px; border: 1px solid var(--border);">
                <input type="date" id="filterStart" onchange="loadDashboard()" style="border:none; width:auto; padding:5px; margin:0;"> | 
                <input type="date" id="filterEnd" onchange="loadDashboard()" style="border:none; width:auto; padding:5px; margin:0;">
            </div>
            
            <input type="file" id="excelInput" hidden accept=".xlsx, .xls" onchange="uploadExcel(this)">
            <button id="importBtn" onclick="document.getElementById('excelInput').click()" class="btn-primary" style="width:auto; padding: 10px 15px; background: #f59e0b;">
                <i class="fa-solid fa-file-import"></i> Import Excel
            </button>
            <button id="exportBtn" onclick="downloadExcel()" class="btn-success" style="width:auto; padding: 10px 15px;">
                <i class="fa-solid fa-file-excel"></i> Export Report
            </button>

            <div class="user-badge">
                <div style="width:8px; height:8px; background:var(--secondary); border-radius:50%;"></div>
                <span id="currentUserDisplay">Loading...</span>
            </div>
            <input type="hidden" id="cashierName"> 
            
            <a href="/logout"><button style="background:var(--dark); width:auto; padding: 10px 15px;"><i class="fa-solid fa-power-off"></i></button></a>
        </div>
    </div>

    <div id="dashboardSection" class="hidden">
        <div class="grid-dashboard-top">
            <div class="card stat-card"><h3>Total Revenue</h3><h2 id="statRevenue">‚Çπ0.00</h2><div style="font-size:0.8em; color:var(--secondary); margin-top:5px;">‚Üó Live Updates</div></div>
            <div class="card stat-card"><h3>Total Orders</h3><h2 id="statOrders">0</h2><div style="font-size:0.8em; color:var(--primary); margin-top:5px;">üìã Processed</div></div>
            <div class="card stat-card"><h3>Stock Alerts</h3><h2 id="statLowStock" style="color:var(--danger);">0</h2><div style="font-size:0.8em; color:var(--danger); margin-top:5px;">‚ö† Action Needed</div></div>
            <div class="card stat-card" style="background: linear-gradient(135deg, #7e22ce 0%, #a855f7 100%); color: white;">
                <h3 style="color:white; opacity:0.9;">AI Forecast</h3><div style="font-size:0.8em; opacity:0.8;">Next 7 Days</div><h2 id="statPrediction" style="color:white; margin-top:5px;">0 Units</h2><div style="margin-top:5px; font-size:0.8em;"><i class="fa-solid fa-robot"></i> ML Powered</div>
            </div>
        </div>
        
        <div class="grid-dashboard-bottom">
            <div class="card">
                <h3>Sales Activity</h3>
                <div style="height:250px;"><canvas id="salesChart"></canvas></div>
            </div>
            <div class="card">
                <h3>Best Sellers</h3>
                <div style="height:250px; display:flex; justify-content:center;"><canvas id="productsChart"></canvas></div>
            </div>
            <div class="card">
                <h3>üèÜ VIP Customers</h3>
                <table style="margin-top:10px;">
                    <tbody id="vipTable"><tr><td style="text-align:center; color:#ccc;">Loading Data...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="grid-main">
        
        <div class="card hidden" id="inventorySection">
            <div class="flex-between" style="margin-bottom:20px;">
                <h2 style="margin:0;">Inventory Master</h2>
                <div style="position:relative;">
                    <i class="fa-solid fa-search" style="position:absolute; left:10px; top:12px; color:#9ca3af;"></i>
                    <input type="text" id="inventorySearch" placeholder="Search products..." onkeyup="filterInventory()" style="width:300px; padding-left:35px; margin:0;">
                </div>
            </div>
            
            <input type="hidden" id="prodId"> 
            <div style="background: #fff; padding:20px; border-radius:12px; border:1px solid var(--border); margin-bottom:20px;">
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:15px;">
                    <input type="text" id="prodName" placeholder="Product Name (e.g. iPhone 15)" onkeyup="detectProductDetails()">
                    <input type="text" id="prodBrand" placeholder="Brand (Auto-Detect)">
                    <input type="text" id="prodCategory" placeholder="Category (Auto-Detect)">
                </div>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px;">
                    <input type="number" id="prodPrice" placeholder="Price (‚Çπ)">
                    <input type="number" id="prodDiscount" placeholder="Discount (%)">
                    <input type="number" id="prodStock" placeholder="Initial Stock">
                </div>
                
                <button id="saveBtn" class="btn-primary" onclick="saveProduct()" style="margin-top:15px; padding: 15px; font-size:1.1em;">
                    <i class="fa-solid fa-plus"></i> Add to Inventory
                </button>
                <button id="cancelBtn" onclick="resetForm()" class="hidden" style="margin-top:10px; background:#6b7280;">Cancel Edit</button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th width="10%">ID</th>
                        <th width="40%">PRODUCT</th>
                        <th width="15%">PRICE</th>
                        <th width="20%">STOCK HEALTH</th>
                        <th width="15%" style="text-align:right;">ACTIONS</th>
                    </tr>
                </thead>
                <tbody id="inventoryTable"></tbody>
            </table>
        </div>

        <div id="billingSection" class="pos-container hidden">
            
            <div class="pos-billing-panel">
                <div class="billing-header">
                    <div style="font-weight: 700; font-size: 1.1em;"><i class="fa-solid fa-cash-register"></i> POS Terminal</div>
                    <div id="posDateDisplay" style="font-size: 0.8em; opacity: 0.8; background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 12px;"></div>
                </div>

                <div class="billing-tools">
                    <button onclick="toggleScanner()" style="background: #8B5CF6; padding: 10px; font-size: 0.9em;"><i class="fa-solid fa-qrcode"></i> Scan Product QR</button>
                    <button onclick="clearCart()" style="background: #fee2e2; color: #ef4444; width: auto; padding: 10px;"><i class="fa-solid fa-trash"></i></button>
                </div>
                <div id="reader" style="display:none; overflow:hidden;"></div>

                <div class="billing-cart-area">
                    <table style="margin:0;">
                        <thead><tr><th>ITEM</th><th style="text-align:center;">QTY</th><th style="text-align:right;">TOTAL</th><th></th></tr></thead>
                        <tbody id="cartTable"></tbody>
                    </table>
                </div>

                <div class="billing-footer">
                    <div class="flex-between" style="margin-bottom: 10px;">
                        <span style="color: #6b7280; font-weight: 600;">Grand Total</span>
                        <span style="font-size: 1.8em; font-weight: 800; color: var(--dark);">‚Çπ<span id="cartTotal">0.00</span></span>
                    </div>
                    
                    <label style="font-size:0.8em; color:var(--text-muted); font-weight:600;">Customer Loyalty (Phone)</label>
                    <div style="display:flex; gap:10px; margin-bottom: 15px;">
                        <input type="text" id="custPhone" placeholder="Enter Phone Number" style="margin:0;">
                        <div style="background:#ede9fe; color:var(--primary); padding:10px; border-radius:8px; font-weight:bold; font-size:0.9em;"><i class="fa-solid fa-star"></i> Points</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <select id="payMethod" style="margin:0;"><option>Cash</option><option>UPI</option><option>Card</option></select>
                        <select id="payStatus" style="margin:0;"><option>Paid</option><option>Pending</option></select>
                    </div>

                    <button id="btnCheckout" class="btn-success" onclick="checkout()" style="padding: 15px; font-size: 1.1em; width: 100%;">
                        Complete Transaction <i class="fa-solid fa-arrow-right"></i>
                    </button>

                    <div id="postSale" class="success-box hidden">
                        <div class="success-icon"><i class="fa-solid fa-check" style="color:white; font-size:0.6em; background:#10b981; padding:10px; border-radius:50%;"></i></div>
                        <h3 style="color: #065f46; margin: 0 0 15px 0; font-weight: 800;">Sale Confirmed!</h3>
                        
                        <button onclick="shareReceipt()" style="background: var(--primary); width: 100%; margin-bottom: 10px; font-size: 1em; padding:12px;">
                            <i class="fa-solid fa-share-nodes"></i> Share Invoice
                        </button>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                            <button onclick="downloadReceipt()" style="background: #15803d; font-size: 0.9em; padding: 10px;"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                            <button onclick="printThermal()" style="background: #1e293b; font-size: 0.9em; padding: 10px;"><i class="fa-solid fa-print"></i> Thermal</button>
                            <button onclick="startNewSale()" style="background: #4b5563; font-size: 0.9em; padding: 10px;">New Sale</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pos-catalog-panel">
                <div class="flex-between" style="margin-bottom: 15px;">
                    <h2 style="margin:0; font-size: 1.3em;">Product Catalog</h2>
                    <div style="position:relative; width: 50%;">
                        <i class="fa-solid fa-search" style="position:absolute; left:10px; top:12px; color:#9ca3af;"></i>
                        <input type="text" id="posSearch" placeholder="Search name or code..." onkeyup="renderCatalog()" style="width:100%; padding-left:35px; margin:0;">
                    </div>
                </div>
                
                <div id="productGrid" class="catalog-grid"></div>
            </div>

        </div>
    </div>

    <div id="thermal-receipt">
        <div class="receipt-header">
            <h2 style="margin:0;">SMARTSTORE</h2>
            <div>POS Terminal #1</div>
            <div id="receipt-date">--/--/----</div>
            <div>Order: <span id="receipt-id">#</span></div>
        </div>
        <div id="receipt-items-list" style="margin: 10px 0; font-size: 12px;"></div>
        <div style="border-top: 1px dashed #000; padding-top: 5px; display:flex; justify-content:space-between; font-weight:bold;">
            <span>TOTAL</span><span id="receipt-total">‚Çπ0.00</span>
        </div>
        <div class="receipt-footer"><p>Thank you for shopping!</p></div>
    </div>

    <script>
        const API = '/api'; 
        let products = [], cart = [], lastSaleId = null;
        let salesChartRef = null, productChartRef = null;
        let html5QrcodeScanner = null;
        
        function playBeep() { 
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator(); const gain = ctx.createGain();
            osc.type = 'sine'; osc.frequency.setValueAtTime(800, ctx.currentTime);
            gain.gain.setValueAtTime(0.05, ctx.currentTime); 
            osc.connect(gain); gain.connect(ctx.destination); 
            osc.start(); osc.stop(ctx.currentTime + 0.1);
        }

        document.addEventListener('DOMContentLoaded', () => { 
            loadCurrentUser(); 
            document.getElementById('posDateDisplay').innerText = new Date().toLocaleDateString();
        });

        function loadCurrentUser() {
            fetch('/api/me').then(res => res.json()).then(data => {
                document.getElementById('currentUserDisplay').innerText = data.username + " (" + (data.role || 'Staff') + ")";
                document.getElementById('cashierName').value = data.username; 
                
                // Add the class 'admin-view' to body ONLY if user is ADMIN
                if (data.role === 'ADMIN') {
                    document.getElementById('mainBody').classList.add('admin-view');
                    document.getElementById('dashboardSection').classList.remove('hidden');
                    document.getElementById('inventorySection').classList.remove('hidden');
                    loadDashboard(); loadInventory(); 
                } else {
                    document.getElementById('mainBody').classList.remove('admin-view');
                    document.getElementById('billingSection').classList.remove('hidden'); 
                    document.getElementById('adminControls').remove();
                    document.getElementById('exportBtn').remove(); 
                    document.getElementById('importBtn').remove(); 
                    loadInventory(); 
                }
            });
        }

        // --- DASHBOARD ---
        function loadDashboard() {
            const start = document.getElementById('filterStart').value;
            const end = document.getElementById('filterEnd').value;
            const url = start && end ? `${API}/dashboard/stats?startDate=${start}&endDate=${end}` : `${API}/dashboard/stats`;
            
            fetch(url).then(res => res.json()).then(s => {
                document.getElementById('statRevenue').innerText = '‚Çπ' + (s.totalRevenue || 0).toFixed(2);
                document.getElementById('statOrders').innerText = s.totalOrders || 0;
                document.getElementById('statLowStock').innerText = s.lowStockCount || 0;
                document.getElementById('statPrediction').innerText = (s.predictedSales || 0) + " Units";
                initCharts(s.totalOrders, s.lowStockCount, s.topProducts);
                
                const vipTable = document.getElementById('vipTable');
                if(s.topCustomers && s.topCustomers.length > 0) {
                    vipTable.innerHTML = s.topCustomers.map((c, i) => `
                        <tr>
                            <td style="padding:12px;">
                                <div style="font-weight:600; color:var(--dark);">${i+1}. ${c.name || 'Loyal Customer'}</div>
                                <div style="font-size:0.8em; color:var(--text-muted);">${c.phone}</div>
                            </td>
                            <td style="text-align:right; font-weight:bold; color:var(--primary);">
                                <i class="fa-solid fa-star" style="font-size:0.8em;"></i> ${c.points}
                            </td>
                        </tr>`).join('');
                } else {
                    vipTable.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:20px; color:#ccc;">No VIP Data Yet</td></tr>';
                }
            });
        }

        function initCharts(orders, alerts, topProducts) {
            const ctx1 = document.getElementById('salesChart').getContext('2d');
            if (salesChartRef) salesChartRef.destroy();
            salesChartRef = new Chart(ctx1, { type: 'bar', data: { labels: ['Total Orders', 'Stock Alerts'], datasets: [{ label: 'Count', data: [orders, alerts], backgroundColor: ['#7e22ce', '#ef4444'], borderRadius: 6, barThickness: 50 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } } } });

            const ctx2 = document.getElementById('productsChart').getContext('2d');
            if (productChartRef) productChartRef.destroy();
            productChartRef = new Chart(ctx2, { type: 'doughnut', data: { labels: Object.keys(topProducts || {}), datasets: [{ data: Object.values(topProducts || {}), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'], borderWidth: 0 }] }, options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels:{boxWidth:10} } } } });
        }

        function loadInventory() { fetch(`${API}/products`).then(r=>r.json()).then(d=>{ products=d; renderInv(); renderCatalog(); }); }

        // --- CATALOG ---
        function renderCatalog() {
            const grid = document.getElementById('productGrid');
            if(!grid || grid.offsetParent === null) return; 
            const term = document.getElementById('posSearch').value.toLowerCase();
            const filtered = products.filter(p => p.name.toLowerCase().includes(term) || String(p.id).includes(term));
            
            grid.innerHTML = filtered.map(p => {
                let stockClass = 'stock-badge';
                let action = `addToCart({id:${p.id}})`;
                if(p.stock <= 5) stockClass += ' stock-low';
                if(p.stock === 0) { stockClass += ' stock-out'; action = ''; }

                return `
                <div class="product-card ${p.stock===0?'stock-out':''}" onclick="${action}">
                    <div>
                        <h4>${p.name}</h4>
                        <div style="font-size:0.8em; color:#6b7280;">${p.brand || 'Generic'}</div>
                    </div>
                    <div class="flex-between" style="align-items: flex-end;">
                        <div class="price">‚Çπ${p.price}</div>
                        <div class="${stockClass}">${p.stock} left</div>
                    </div>
                </div>`;
            }).join('');
        }

        function addToCart(obj) {
            playBeep();
            let p = products.find(x => x.id === obj.id);
            let item = cart.find(i => i.productId === obj.id);
            let currentQty = item ? item.quantity : 0;
            if(p.stock <= currentQty) return alert("‚ùå Out of Stock!");
            if(item) item.quantity++; else cart.push({productId: obj.id, name: p.name, price: p.price, quantity: 1});
            renderCart();
        }

        function removeFromCart(idx) { cart.splice(idx, 1); renderCart(); }
        function clearCart() { if(confirm("Clear Cart?")) { cart = []; renderCart(); } }

        function renderCart() { 
            document.getElementById('cartTable').innerHTML = cart.map((i, idx) => `<tr><td>${i.name}</td><td style="text-align:center;">${i.quantity}</td><td style="text-align:right;">‚Çπ${(i.price*i.quantity).toFixed(2)}</td><td style="text-align:center; color:var(--danger); cursor:pointer;" onclick="removeFromCart(${idx})"><i class="fa-solid fa-times"></i></td></tr>`).join('');
            document.getElementById('cartTotal').innerText = cart.reduce((a,b)=>a+(b.price*b.quantity),0).toFixed(2);
        }

        function checkout() { 
            if(cart.length === 0) return alert("Cart Empty");
            const btn = document.getElementById('btnCheckout');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
            
            fetch(`${API}/sales`, { 
                method:'POST', headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({ items:cart, cashierName: document.getElementById('cashierName').value, customerPhone: document.getElementById('custPhone').value, paymentMethod: document.getElementById('payMethod').value, status: document.getElementById('payStatus').value }) 
            }).then(r=>r.json()).then(d=>{ 
                lastSaleId=d.id; btn.classList.add('hidden'); 
                document.getElementById('postSale').classList.remove('hidden'); 
                loadInventory(); document.getElementById('custPhone').value = '';
            });
        }

        function startNewSale() { 
            cart=[]; renderCart(); 
            document.getElementById('postSale').classList.add('hidden'); 
            document.getElementById('btnCheckout').classList.remove('hidden'); 
            document.getElementById('btnCheckout').innerHTML = 'Complete Transaction <i class="fa-solid fa-arrow-right"></i>';
        }

        // --- ADMIN INVENTORY ---
        function renderInv() { 
            const t = document.getElementById('inventoryTable'); if(!t) return; t.innerHTML=''; 
            products.forEach(p => {
                let status = p.stock <= 5 ? '<span style="color:red; font-weight:bold;">Low</span>' : '<span style="color:green; font-weight:bold;">Good</span>';
                let barColor = p.stock <= 5 ? '#ef4444' : '#10b981';
                t.innerHTML += `<tr>
                    <td style="color:var(--primary); font-weight:bold;">PRD-${p.id}</td>
                    <td><b>${p.name}</b><br><small style="color:#6b7280;">${p.brand} ‚Ä¢ ${p.category}</small></td>
                    <td><b>‚Çπ${p.price.toFixed(2)}</b></td>
                    <td><div class="flex-between" style="font-size:0.8em; margin-bottom:2px;"><span>${p.stock} units</span>${status}</div><div style="height:6px; background:#e5e7eb; border-radius:3px;"><div style="height:100%; width:${Math.min(p.stock,100)}%; background:${barColor}; border-radius:3px;"></div></div></td>
                    <td style="text-align:right;"><button onclick="editProduct(${p.id})" style="background:#f59e0b; width:30px; height:30px; padding:0; border-radius:6px; margin-right:5px;"><i class="fa-solid fa-pen"></i></button><button onclick="deleteProduct(${p.id})" style="background:#ef4444; width:30px; height:30px; padding:0; border-radius:6px;"><i class="fa-solid fa-trash"></i></button></td>
                </tr>`; 
            }); 
        }
        function saveProduct() { 
             const product = { name: document.getElementById('prodName').value, brand: document.getElementById('prodBrand').value, category: document.getElementById('prodCategory').value, price: parseFloat(document.getElementById('prodPrice').value), discount: parseFloat(document.getElementById('prodDiscount').value)||0, stock: parseInt(document.getElementById('prodStock').value) };
             const id = document.getElementById('prodId').value;
             fetch(id ? `${API}/products/${id}` : `${API}/products`, { method: id ? 'PUT' : 'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(product)})
             .then(() => { resetForm(); loadInventory(); });
        }
        function editProduct(id) {
            const p = products.find(x => x.id === id);
            document.getElementById('prodId').value = p.id;
            document.getElementById('prodName').value = p.name;
            document.getElementById('prodBrand').value = p.brand;
            document.getElementById('prodCategory').value = p.category;
            document.getElementById('prodPrice').value = p.price;
            document.getElementById('prodStock').value = p.stock;
            document.getElementById('saveBtn').innerHTML = '<i class="fa-solid fa-check"></i> Update Product';
            document.getElementById('cancelBtn').classList.remove('hidden');
        }
        function resetForm() { document.querySelectorAll('#inventorySection input').forEach(i => i.value=''); document.getElementById('prodId').value = ''; document.getElementById('saveBtn').innerHTML = '<i class="fa-solid fa-plus"></i> Add to Inventory'; document.getElementById('cancelBtn').classList.add('hidden'); }
        function deleteProduct(id) { if(confirm("Delete item?")) fetch(`${API}/products/${id}`, {method:'DELETE'}).then(loadInventory); }
        function filterInventory() { const term = document.getElementById('inventorySearch').value.toLowerCase(); document.querySelectorAll('#inventoryTable tr').forEach(row => { row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none'; }); }
        function detectProductDetails() { const name = document.getElementById('prodName').value.toLowerCase(); const match = [{k:'iphone',b:'Apple',c:'Electronics'}, {k:'nike',b:'Nike',c:'Apparel'}].find(r => name.includes(r.k)); if(match) { document.getElementById('prodBrand').value = match.b; document.getElementById('prodCategory').value = match.c; } }
        function uploadExcel(input) { const fd=new FormData(); fd.append("file", input.files[0]); fetch(`${API}/products/upload`,{method:'POST',body:fd}).then(r=>r.text()).then(m=>{ alert(m); loadInventory(); }); }
        function downloadExcel() { window.open(`${API}/sales/export`, '_blank'); }
        async function shareReceipt() { try { const r = await fetch(`/api/sales/${lastSaleId}/pdf`); const b = await r.blob(); const f = new File([b], `Invoice-${lastSaleId}.pdf`, { type: "application/pdf" }); await navigator.share({ files: [f] }); } catch (e) { window.open(`/api/sales/${lastSaleId}/pdf`); } }
        function downloadReceipt() { window.open(`${API}/sales/${lastSaleId}/pdf`, '_blank'); }
        
        function toggleScanner() {
            const r = document.getElementById('reader');
            if (r.style.display === 'none') {
                r.style.display = 'block';
                html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
                html5QrcodeScanner.render((txt) => { let p = products.find(x => x.name.toLowerCase()===txt.toLowerCase() || x.id==txt); if(p) { addToCart({id:p.id}); html5QrcodeScanner.pause(); setTimeout(()=>html5QrcodeScanner.resume(), 1500); } });
            } else { if(html5QrcodeScanner) html5QrcodeScanner.clear(); r.style.display = 'none'; }
        }
        function printThermal() {
            document.getElementById('receipt-date').innerText = new Date().toLocaleString();
            document.getElementById('receipt-id').innerText = lastSaleId || "PENDING";
            document.getElementById('receipt-total').innerText = document.getElementById('cartTotal').innerText;
            const list = document.getElementById('receipt-items-list'); list.innerHTML = '';
            cart.forEach(item => { list.innerHTML += `<div class="receipt-item"><span>${item.name} x${item.quantity}</span><span>‚Çπ${(item.price * item.quantity).toFixed(2)}</span></div>`; });
            window.print(); 
        }
    </script>
</body>
</html>