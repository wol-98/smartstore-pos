<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SmartStore Manager Suite</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script> 
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- STABLE ENTERPRISE THEME --- */
        :root { 
            --primary: #7e22ce; --primary-dark: #6b21a8; --secondary: #10B981; --danger: #EF4444; 
            --warning: #F59E0B; --dark: #1e293b; 
            --light: #f3f4f6; --card-bg: #ffffff; 
            --border: #e5e7eb; --text-main: #1f2937; --text-muted: #6b7280;
            --input-bg: #ffffff;
        }

        body.dark-mode {
            --light: #0f172a; --card-bg: #1e293b; --border: #334155;
            --text-main: #f1f5f9; --text-muted: #94a3b8; --input-bg: #0f172a;
            --dark: #f8fafc;
        }

        body { 
            font-family: 'Inter', sans-serif; background: var(--light); padding: 20px; 
            color: var(--text-main); margin: 0; height: 100vh; 
            display: flex; flex-direction: column; overflow: hidden; box-sizing: border-box; 
            transition: background 0.3s, color 0.3s; 
        }
        
        body.admin-view { height: auto !important; overflow-y: auto !important; display: block !important; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .hidden { display: none !important; }
        .header-container { margin-bottom: 20px; flex-shrink: 0; }
        
        /* LAYOUTS */
        .grid-dashboard-top { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
        .grid-dashboard-bottom { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .pos-container { display: grid; grid-template-columns: 1.2fr 1.8fr; gap: 20px; height: calc(100vh - 100px); overflow: hidden; }

        /* PANELS */
        .pos-billing-panel { display: flex; flex-direction: column; background: var(--card-bg); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); height: 100%; transition: background 0.3s; }
        .billing-header { padding: 15px; background: #1e293b; color: white; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .billing-tools { padding: 10px; border-bottom: 1px solid var(--border); flex-shrink: 0; display: flex; gap: 8px; background: var(--light); }
        .billing-cart-area { flex-grow: 1; overflow-y: auto; background: var(--card-bg); }
        .billing-footer { padding: 20px; background: var(--card-bg); border-top: 1px solid var(--border); flex-shrink: 0; }
        .pos-catalog-panel { display: flex; flex-direction: column; overflow: hidden; height: 100%; }
        .catalog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; overflow-y: auto; padding-right: 5px; padding-bottom: 20px; }

        /* CARDS */
        .card { background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid var(--border); transition: background 0.3s; }
        .stat-card h2 { font-size: 2.2em; margin: 5px 0 0; color: var(--text-main); font-weight: 700; }
        .stat-card { position: relative; overflow: hidden; }
        .stat-card::before { content:''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: var(--primary); }
        
        .vip-scroll-area { max-height: 250px; overflow-y: auto; scrollbar-width: thin; }
        
        /* INPUTS & BUTTONS */
        input, select { padding: 12px; border: 1px solid var(--border); border-radius: 8px; width: 100%; box-sizing: border-box; background: var(--input-bg); color: var(--text-main); font-size: 0.95em; transition: 0.2s; outline: none; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(126, 34, 206, 0.1); }
        button { padding: 12px; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; width: 100%; transition: 0.2s; font-size: 0.95em; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: var(--primary); } .btn-success { background: var(--secondary); }
        
        /* PRODUCT & BADGES */
        .product-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 15px; cursor: pointer; transition: 0.1s; display: flex; flex-direction: column; justify-content: space-between; height: 110px; user-select: none; position: relative; }
        .product-card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(126, 34, 206, 0.1); }
        .product-card h4 { margin: 0 0 5px 0; font-size: 0.95em; color: var(--text-main); line-height: 1.3; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .price { font-weight: 700; color: var(--primary); font-size: 1.1em; }
        .stock-badge { position: absolute; bottom: 12px; right: 12px; font-size: 0.75em; padding: 3px 8px; border-radius: 6px; background: var(--light); color: var(--text-muted); font-weight: 700; border: 1px solid var(--border); }
        .stock-low { background: #fee2e2 !important; color: #dc2626 !important; border-color: #fecaca !important; }
        .stock-out { opacity: 0.5; pointer-events: none; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; background: var(--light); font-size: 0.75em; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; z-index: 2; border-bottom: 1px solid var(--border); } 
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.9em; vertical-align: middle; }
        
        /* UNDO TOAST */
        #undoToast {
            visibility: hidden; min-width: 300px; background-color: #333; color: #fff; text-align: center;
            border-radius: 8px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px;
            transform: translateX(-50%); font-size: 1em; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: flex; justify-content: space-between; align-items: center;
        }
        #undoToast.show { visibility: visible; animation: fadein 0.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        
        .success-box { background-color: #ecfdf5; border: 1px solid #6ee7b7; border-radius: 12px; padding: 20px; text-align: center; margin-top: 15px; animation: fadeIn 0.3s ease-in; }
        body.dark-mode .success-box { background-color: #064e3b; border-color: #059669; }
        .success-icon { color: #10b981; font-size: 3em; margin-bottom: 10px; background: white; border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px auto; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .user-badge { background: var(--card-bg); border: 1px solid var(--border); padding: 8px 16px; border-radius: 30px; font-weight: 600; font-size: 0.9em; display: flex; align-items: center; gap: 8px; }

        /* üöÄ FIXED THERMAL RECEIPT CSS */
        #thermal-receipt { display: none; } 
        @media print { 
            body * { visibility: hidden; } 
            #thermal-receipt { display: block !important; visibility: visible; position: absolute; left: 0; top: 0; width: 100%; font-family: 'Courier New', Courier, monospace; color: #000; padding: 5px; font-size: 11px; line-height: 1.3; }
            #thermal-receipt * { visibility: visible; }
            .t-header { text-align: center; margin-bottom: 15px; text-transform: uppercase; }
            .t-title { font-size: 1.4em; font-weight: 900; margin: 0 0 5px 0; letter-spacing: 1px; }
            .t-sub { font-size: 0.9em; color: #333; margin-bottom: 2px; }
            .t-meta-grid { display: grid; grid-template-columns: 1fr 1fr; margin-bottom: 10px; font-size: 0.9em; border-bottom: 1px solid #000; padding-bottom: 5px; }
            
            /* Table Layout Fixed */
            .t-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; table-layout: fixed; }
            .t-table th, .t-table td { border: 1px solid #000; padding: 4px; vertical-align: top; word-wrap: break-word; overflow: hidden; font-size: 10px; }
            
            /* Columns sizing */
            .t-table th:nth-child(1) { width: 10%; } /* # */
            .t-table th:nth-child(2) { width: 40%; } /* Item */
            .t-table th:nth-child(3) { width: 20%; } /* Price */
            .t-table th:nth-child(4) { width: 10%; } /* Qty */
            .t-table th:nth-child(5) { width: 20%; } /* Total */

            .t-table th { background: #f0f0f0 !important; font-weight: 800; text-align: center; -webkit-print-color-adjust: exact; }
            .t-total-row { display: flex; justify-content: space-between; font-size: 1.2em; font-weight: 900; margin-top: 5px; padding: 5px 0; border-top: 2px solid #000; border-bottom: 2px solid #000; }
            .t-footer { text-align: center; margin-top: 20px; font-size: 0.8em; border-top: 1px dashed #000; padding-top: 10px; }
            @page { margin: 0; size: 80mm auto; }
        }
    </style>
</head>
<body id="mainBody">
    
    <div class="header-container flex-between">
        <div><h1 style="margin:0; font-size: 1.6em;"><i class="fa-solid fa-cube" style="color:var(--primary);"></i> SmartStore</h1></div>
        <div style="display:flex; gap:10px; align-items:center;">
            <div id="adminControls" style="display:flex; gap:5px; align-items:center; background: var(--card-bg); padding: 5px; border-radius: 12px; border: 1px solid var(--border);">
                <input type="date" id="filterStart" onchange="loadDashboard()" style="border:none; width:auto; padding:5px; margin:0; background: transparent; color: var(--text-main);"> | 
                <input type="date" id="filterEnd" onchange="loadDashboard()" style="border:none; width:auto; padding:5px; margin:0; background: transparent; color: var(--text-main);">
            </div>
            <input type="file" id="excelInput" hidden accept=".xlsx, .xls" onchange="uploadExcel(this)">
            <button id="importBtn" onclick="document.getElementById('excelInput').click()" class="btn-primary" style="width:auto; padding: 10px 15px; background: #f59e0b;"><i class="fa-solid fa-file-import"></i> Import</button>
            <button id="exportBtn" onclick="downloadExcel()" class="btn-success" style="width:auto; padding: 10px 15px;"><i class="fa-solid fa-file-excel"></i> Export</button>
            
            <button onclick="toggleTheme()" style="background:transparent; border:1px solid var(--border); color:var(--text-main); width:auto; padding:10px 15px;" title="Switch Theme">
                <i id="themeIcon" class="fa-solid fa-moon"></i>
            </button>

            <div class="user-badge"><span id="currentUserDisplay">Loading...</span></div>
            <input type="hidden" id="cashierName"> 
            <a href="/logout"><button style="background:#1e293b; width:auto; padding: 10px 15px;"><i class="fa-solid fa-power-off"></i></button></a>
        </div>
    </div>

    <div id="dashboardSection" class="hidden">
        <div class="grid-dashboard-top">
            <div class="card stat-card"><h3>Total Revenue</h3><h2 id="statRevenue">‚Çπ0.00</h2><div style="font-size:0.8em; color:var(--secondary);">‚Üó Live Updates</div></div>
            <div class="card stat-card"><h3>Total Orders</h3><h2 id="statOrders">0</h2><div style="font-size:0.8em; color:var(--primary);">üìã Processed</div></div>
            <div class="card stat-card"><h3>Stock Alerts</h3><h2 id="statLowStock" style="color:var(--danger);">0</h2><div style="font-size:0.8em; color:var(--danger);">‚ö† Action Needed</div></div>
            <div class="card stat-card" style="background: linear-gradient(135deg, #7e22ce 0%, #a855f7 100%); color: white;">
                <h3 style="color:white; opacity:0.9;">AI Forecast</h3><h2 id="statPrediction" style="color:white; margin-top:5px;">...</h2><div style="margin-top:5px; font-size:0.8em;"><i class="fa-solid fa-robot"></i> ML Powered</div>
            </div>
        </div>
        <div class="grid-dashboard-bottom">
            <div class="card"><h3>Sales Activity</h3><div style="height:250px;"><canvas id="salesChart"></canvas></div></div>
            <div class="card"><h3>Best Sellers</h3><div style="height:250px; display:flex; justify-content:center;"><canvas id="productsChart"></canvas></div></div>
            <div class="card"><h3>üèÜ VIP Customers</h3><div class="vip-scroll-area"><table style="margin-top:10px;"><tbody id="vipTable"></tbody></table></div></div>
        </div>
    </div>

    <div id="undoToast">
        <span>üóëÔ∏è Product Deleted</span>
        <button onclick="undoDelete()" style="background: transparent; border: 1px solid #777; padding: 5px 10px; font-size: 0.9em; margin-left: 10px; color: #F59E0B;">UNDO</button>
    </div>

    <div class="grid-main">
        <div class="card hidden" id="inventorySection">
            <div class="flex-between" style="margin-bottom:20px;">
                <h2 style="margin:0;">Inventory Master</h2>
                <input type="text" id="inventorySearch" placeholder="Search products..." onkeyup="filterInventory()" style="width:300px;">
            </div>
            <input type="hidden" id="prodId"> 
            <div style="background: var(--light); padding:20px; border-radius:12px; border:1px solid var(--border); margin-bottom:20px;">
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:15px;">
                    <input type="text" id="prodName" placeholder="Name" onkeyup="detectProductDetails()">
                    <input type="text" id="prodBrand" placeholder="Brand">
                    <input type="text" id="prodCategory" placeholder="Category">
                </div>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px;">
                    <input type="number" id="prodPrice" placeholder="Price (‚Çπ)">
                    <input type="number" id="prodDiscount" placeholder="Discount (%)">
                    <input type="number" id="prodStock" placeholder="Stock">
                </div>
                <button id="saveBtn" class="btn-primary" onclick="saveProduct()" style="margin-top:15px; padding: 15px; font-size:1.1em;"><i class="fa-solid fa-plus"></i> Add to Inventory</button>
                <button id="cancelBtn" onclick="resetForm()" class="hidden" style="margin-top:10px; background:#6b7280;">Cancel Edit</button>
            </div>
            <table><thead><tr><th>ID</th><th>PRODUCT</th><th>PRICE</th><th>STOCK</th><th>ACTIONS</th></tr></thead><tbody id="inventoryTable"></tbody></table>
        </div>

        <div id="billingSection" class="pos-container hidden">
            <div class="pos-billing-panel">
                <div class="billing-header"><div style="font-weight:700; font-size:1.1em;"><i class="fa-solid fa-cash-register"></i> POS Terminal</div><div id="posDateDisplay" style="font-size:0.8em; opacity:0.8; background:rgba(255,255,255,0.2); padding:3px 8px; border-radius:12px;"></div></div>
                <div class="billing-tools">
                    <button onclick="toggleScanner()" style="background:#8B5CF6; padding:10px; font-size:0.9em;"><i class="fa-solid fa-qrcode"></i> Scan QR</button>
                    <button onclick="clearCart()" style="background:#fee2e2; color:#ef4444; width:auto; padding:10px;"><i class="fa-solid fa-trash"></i></button>
                </div>
                <div id="reader" style="display:none; overflow:hidden; position:relative; background:black;">
                    <button onclick="toggleScanner()" style="position:absolute; top:5px; right:5px; background:red; color:white; z-index:100; width:auto; padding:5px 10px; border-radius:4px;">Close X</button>
                </div>
                <div class="billing-cart-area"><table style="margin:0;"><thead><tr><th>ITEM</th><th style="text-align:center;">QTY</th><th style="text-align:right;">TOTAL</th><th></th></tr></thead><tbody id="cartTable"></tbody></table></div>
                <div class="billing-footer">
                    <div class="flex-between" style="margin-bottom:10px;"><span style="color:#6b7280; font-weight:600;">Grand Total</span><span style="font-size:1.8em; font-weight:800; color:var(--text-main);">‚Çπ<span id="cartTotal">0.00</span></span></div>
                    <label style="font-size:0.8em; color:var(--text-muted); font-weight:600;">Customer Details</label>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <input type="email" id="custEmail" placeholder="Email (For Invoice)" style="margin:0; width:50%;">
                        <input type="text" id="custPhone" placeholder="Phone (Loyalty)" style="margin:0; width:50%;">
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                        <select id="payMethod"><option>Cash</option><option>UPI</option><option>Card</option></select>
                        <select id="payStatus"><option>Paid</option><option>Pending</option></select>
                    </div>
                    <button id="btnCheckout" class="btn-success" onclick="checkout()" style="padding:15px; font-size:1.1em; width:100%;">Complete Transaction <i class="fa-solid fa-arrow-right"></i></button>
                    
                    <div id="postSale" class="success-box hidden">
                        <div class="success-icon"><i class="fa-solid fa-check" style="color:white; font-size:0.6em; background:#10b981; padding:10px; border-radius:50%;"></i></div>
                        <h3 style="color:#065f46; margin:0 0 10px 0; font-weight:800;">Sale Confirmed!</h3>
                        <div style="display:flex; gap:5px; margin-bottom:10px;">
                            <input type="email" id="shareEmail" placeholder="Confirm Email..." style="border:1px solid #d1d5db; padding:8px;">
                            <button onclick="shareReceipt()" style="background:var(--primary); width:auto; padding:8px 15px;"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
                            <button onclick="downloadReceipt()" style="background:#15803d; font-size:0.9em; padding:10px;"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                            <button onclick="printThermal()" style="background:#1e293b; font-size:0.9em; padding:10px;"><i class="fa-solid fa-print"></i> Thermal</button>
                            <button onclick="startNewSale()" style="background:#4b5563; font-size:0.9em; padding:10px;">New</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pos-catalog-panel">
                <div class="flex-between" style="margin-bottom:15px;">
                    <h2 style="margin:0; font-size:1.3em;">Product Catalog</h2>
                    <input type="text" id="posSearch" placeholder="üîç Search item..." onkeyup="renderCatalog()" style="width:50%;">
                </div>
                <div class="flex-between" style="margin-bottom:10px; background:#f3f4f6; padding:8px; border-radius:8px;">
                    <span style="font-weight:600; font-size:0.9em; color:#333;">‚ö° Bulk Mode:</span>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <label style="font-size:0.8em; color:#333;">Qty:</label>
                        <input type="number" id="bulkQty" value="1" min="1" style="width:60px; padding:5px; text-align:center; font-weight:bold;">
                    </div>
                </div>
                <div id="productGrid" class="catalog-grid"></div>
            </div>
        </div>
    </div>

    <div id="thermal-receipt">
        <div class="t-header">
            <div class="t-title">SMARTSTORE ENTERPRISES</div>
            <div class="t-sub">Tech Innovation Drive, Mumbai - 400090</div>
            <div class="t-sub">Ph: 9089853298 | www.smartstore.com</div>
        </div>
        <div class="t-meta-grid">
            <div style="width:100%">Inv #: <span id="receipt-id"></span></div>
            <div style="width:100%">Date: <span id="receipt-date"></span></div>
            <div style="width:100%">Cashier: <span id="receipt-cashier"></span></div>
        </div>
        <table class="t-table">
            <thead>
                <tr><th style="width:10%;">#</th><th style="width:45%;">Item</th><th style="text-align:right;">Price</th><th style="text-align:center;">Qty</th><th style="text-align:right;">Total</th></tr>
            </thead>
            <tbody id="receipt-items-list"></tbody>
        </table>
        <div class="t-total-row"><span>GRAND TOTAL</span><span id="receipt-total">0.00</span></div>
        <div class="t-footer">
            <div style="font-weight:bold; margin-bottom:5px;">System Validation</div>
            This is a computer-generated invoice.<br>Returns within 7 days with original receipt.<br>
            <div style="margin-top:10px;">*** Thank you for shopping! ***</div>
        </div>
    </div>

    <script>
        const API = '/api'; let products=[], cart=[], lastSaleId=null, html5QrcodeScanner=null;
        let deleteTimeout = null; let productToDelete = null;

        function playBeep() { const ctx = new (window.AudioContext||window.webkitAudioContext)(); const osc=ctx.createOscillator(); const g=ctx.createGain(); osc.type='sine'; osc.frequency.setValueAtTime(800,ctx.currentTime); g.gain.setValueAtTime(0.05,ctx.currentTime); osc.connect(g); g.connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime+0.1); }
        document.addEventListener('DOMContentLoaded', ()=>{ loadCurrentUser(); document.getElementById('posDateDisplay').innerText=new Date().toLocaleDateString(); });

        function loadCurrentUser(){ fetch('/api/me').then(r=>r.json()).then(d=>{ document.getElementById('currentUserDisplay').innerText=d.username+" ("+(d.role||'Staff')+")"; document.getElementById('cashierName').value=d.username; if(d.role==='ADMIN'){ document.getElementById('mainBody').classList.add('admin-view'); document.getElementById('dashboardSection').classList.remove('hidden'); document.getElementById('inventorySection').classList.remove('hidden'); loadDashboard(); loadInventory(); } else { document.getElementById('mainBody').classList.remove('admin-view'); document.getElementById('billingSection').classList.remove('hidden'); document.getElementById('adminControls').remove(); document.getElementById('exportBtn').remove(); document.getElementById('importBtn').remove(); loadInventory(); } }); }

        // üöÄ UPDATED: LAZY LOAD DASHBOARD
        function loadDashboard(){ 
            let start = document.getElementById('filterStart').value;
            let end = document.getElementById('filterEnd').value;

            if (!start || !end) {
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1); 
                const formatDate = (d) => d.toISOString().split('T')[0];
                start = formatDate(firstDay);
                end = formatDate(today);
                document.getElementById('filterStart').value = start;
                document.getElementById('filterEnd').value = end;
            }

            // 1. Fetch Fast Stats
            fetch(`${API}/dashboard/stats?startDate=${start}&endDate=${end}`)
                .then(r => r.json())
                .then(s => { 
                    document.getElementById('statRevenue').innerText = '‚Çπ' + (s.totalRevenue || 0).toFixed(2); 
                    document.getElementById('statOrders').innerText = s.totalOrders || 0; 
                    document.getElementById('statLowStock').innerText = s.lowStockCount || 0; 
                    new Chart(document.getElementById('salesChart'), { type: 'bar', data: { labels: ['Orders', 'Alerts'], datasets: [{ data: [s.totalOrders || 0, s.lowStockCount || 0], backgroundColor: ['#7e22ce', '#EF4444'] }] }, options: { plugins: { legend: { display: false } } } });
                    new Chart(document.getElementById('productsChart'), { type: 'doughnut', data: { labels: Object.keys(s.topProducts || {}), datasets: [{ data: Object.values(s.topProducts || {}), backgroundColor: ['#3b82f6', '#10B981', '#F59E0B', '#EF4444', '#8b5cf6'] }] }, options: { plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } } } });
                    document.getElementById('vipTable').innerHTML = (s.topCustomers || []).map((c, i) => `<tr><td style="padding:10px;"><b>${i + 1}. ${c.name}</b><br><small>${c.phone}</small></td><td style="text-align:right; color:#7e22ce;"><b>‚òÖ ${c.points}</b></td></tr>`).join('') || '<tr><td style="padding:10px; text-align:center;">No VIP Data Yet</td></tr>';
                })
                .catch(err => console.error("Dashboard Load Failed:", err));

            // 2. Fetch Slow AI Stats Separately
            document.getElementById('statPrediction').innerText = "...";
            fetch(`${API}/dashboard/stats/ai`)
                .then(r => r.json())
                .then(ai => {
                    document.getElementById('statPrediction').innerText = (ai.predictedSales || 0) + " Units";
                });
        }

        // üöÄ UPDATED: FAST CATALOG RENDER
        function loadInventory(){ 
            fetch(`${API}/products`).then(r=>r.json()).then(d=>{ 
                products=d; 
                // Render catalog instantly
                requestAnimationFrame(() => renderCatalog()); 
                // Render admin table slightly later
                if(!document.getElementById('inventorySection').classList.contains('hidden')){
                    setTimeout(renderInv, 50); 
                }
            }); 
        }

        function renderCatalog(){ const t=document.getElementById('posSearch').value.toLowerCase(); document.getElementById('productGrid').innerHTML = products.filter(p=>p.name.toLowerCase().includes(t)||String(p.id).includes(t)).map(p=>{ let c='product-card', s='stock-badge', a=`addToCart({id:${p.id}})`; if(p.stock<=5) s+=' stock-low'; if(p.stock===0){ s+=' stock-out'; c+=' opacity-50'; a=''; } return `<div class="${c}" onclick="${a}"><div><h4>${p.name}</h4><small>${p.brand||''}</small></div><div class="flex-between"><div class="price">‚Çπ${p.price}</div><div class="${s}">${p.stock} left</div></div></div>`; }).join(''); }
        
        // üöÄ UPDATED: USE BULK QTY
        function addToCart(o){ 
            playBeep(); 
            let p = products.find(x => x.id === o.id);
            let i = cart.find(x => x.productId === o.id);
            
            let qtyToAdd = parseInt(document.getElementById('bulkQty').value) || 1;
            let currentQty = i ? i.quantity : 0;

            if (p.stock < (currentQty + qtyToAdd)) return alert("Out of Stock"); 
            
            if (i) i.quantity += qtyToAdd; 
            else cart.push({productId:p.id, name:p.name, price:p.price, quantity:qtyToAdd});
            
            // Reset to 1 for safety
            document.getElementById('bulkQty').value = 1; 
            renderCart(); 
        }

        function removeFromCart(i){ cart.splice(i,1); renderCart(); }
        function clearCart(){ if(confirm("Clear?")) { cart=[]; renderCart(); } }
        function renderCart(){ document.getElementById('cartTable').innerHTML=cart.map((i,x)=>`<tr><td>${i.name}</td><td style="text-align:center;">${i.quantity}</td><td style="text-align:right;">‚Çπ${(i.price*i.quantity).toFixed(2)}</td><td onclick="removeFromCart(${x})" style="color:red; cursor:pointer; text-align:center;">√ó</td></tr>`).join(''); document.getElementById('cartTotal').innerText = cart.reduce((a,b)=>a+b.price*b.quantity,0).toFixed(2); }
        
        function checkout() {
            if (!cart.length) return alert("Cart is empty!");
            const btn = document.getElementById('btnCheckout');
            const originalText = btn.innerText;
            btn.innerText = 'Processing...'; btn.disabled = true;
            fetch(`${API}/sales`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items: cart, cashierName: document.getElementById('cashierName').value, customerPhone: document.getElementById('custPhone').value, paymentMethod: document.getElementById('payMethod').value, status: document.getElementById('payStatus').value }) })
            .then(async response => { if (!response.ok) { const errorText = await response.text(); throw new Error(errorText || "Transaction Failed"); } return response.json(); })
            .then(d => { lastSaleId = d.id; document.getElementById('btnCheckout').classList.add('hidden'); document.getElementById('postSale').classList.remove('hidden'); document.getElementById('shareEmail').value = document.getElementById('custEmail').value; loadInventory(); })
            .catch(err => { alert("‚ö†Ô∏è Checkout Failed: " + err.message); btn.innerText = originalText; btn.disabled = false; });
        }

        function startNewSale(){ cart=[]; renderCart(); document.getElementById('postSale').classList.add('hidden'); document.getElementById('btnCheckout').classList.remove('hidden'); document.getElementById('btnCheckout').innerText='Complete Transaction'; document.getElementById('shareEmail').value=''; document.getElementById('custEmail').value=''; }
        
        function saveProduct() {
            const id = document.getElementById('prodId').value;
            const payload = { name: document.getElementById('prodName').value, brand: document.getElementById('prodBrand').value, category: document.getElementById('prodCategory').value, price: parseFloat(document.getElementById('prodPrice').value), stock: parseInt(document.getElementById('prodStock').value) };
            if (id) payload.id = id;
            fetch(`${API}/products`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).then(() => { resetForm(); loadInventory(); });
        }

        function deleteProduct(id) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (row) { row.style.opacity = '0.3'; row.style.pointerEvents = 'none'; }
            productToDelete = id;
            const toast = document.getElementById('undoToast');
            toast.className = "show";
            deleteTimeout = setTimeout(() => { fetch(`${API}/products/${id}`,{method:'DELETE'}).then(loadInventory); toast.className = toast.className.replace("show", ""); }, 4000);
        }

        function undoDelete() {
            clearTimeout(deleteTimeout); 
            const row = document.querySelector(`tr[data-id="${productToDelete}"]`);
            if (row) { row.style.opacity = '1'; row.style.pointerEvents = 'auto'; }
            const toast = document.getElementById('undoToast');
            toast.className = toast.className.replace("show", "");
        }

        function renderInv(){ 
            const t=document.getElementById('inventoryTable'); if(t){ t.innerHTML=''; 
            products.forEach(p=>{ 
                let status = p.stock <= 5 ? '<span style="color:red; font-weight:bold;">Low</span>' : '<span style="color:green; font-weight:bold;">Good</span>';
                let barColor = p.stock <= 5 ? '#ef4444' : '#10b981';
                t.innerHTML+=`<tr data-id="${p.id}"><td style="color:var(--primary); font-weight:bold;">PRD-${p.id}</td><td><b>${p.name}</b><br><small style="color:#6b7280;">${p.brand} ‚Ä¢ ${p.category}</small></td><td><b>‚Çπ${p.price.toFixed(2)}</b></td><td><div class="flex-between" style="font-size:0.8em; margin-bottom:2px;"><span>${p.stock} units</span>${status}</div><div style="height:6px; background:#e5e7eb; border-radius:3px;"><div style="height:100%; width:${Math.min(p.stock,100)}%; background:${barColor}; border-radius:3px;"></div></div></td><td style="text-align:right;"><button onclick="editProduct(${p.id})" style="background:#f59e0b; width:30px; height:30px; padding:0; border-radius:6px; margin-right:5px;"><i class="fa-solid fa-pen"></i></button><button onclick="deleteProduct(${p.id})" style="background:#ef4444; width:30px; height:30px; padding:0; border-radius:6px;"><i class="fa-solid fa-trash"></i></button></td></tr>`; 
            }); } 
        }
        
        function editProduct(id) { const p = products.find(x => x.id === id); document.getElementById('prodId').value = p.id; document.getElementById('prodName').value = p.name; document.getElementById('prodBrand').value = p.brand; document.getElementById('prodCategory').value = p.category; document.getElementById('prodPrice').value = p.price; document.getElementById('prodStock').value = p.stock; document.getElementById('saveBtn').innerHTML = '<i class="fa-solid fa-check"></i> Update Product'; document.getElementById('cancelBtn').classList.remove('hidden'); }
        function resetForm() { document.querySelectorAll('#inventorySection input').forEach(i => i.value=''); document.getElementById('prodId').value = ''; document.getElementById('saveBtn').innerHTML = '<i class="fa-solid fa-plus"></i> Add to Inventory'; document.getElementById('cancelBtn').classList.add('hidden'); }
        
        function toggleScanner(){ const r=document.getElementById('reader'); if(r.style.display==='none'){ r.style.display='block'; html5QrcodeScanner=new Html5QrcodeScanner("reader",{fps:10,qrbox:250}); html5QrcodeScanner.render(t=>{ let p=products.find(x=>x.name.toLowerCase()===t.toLowerCase()||x.id==t); if(p){ addToCart({id:p.id}); html5QrcodeScanner.pause(); setTimeout(()=>html5QrcodeScanner.resume(),1500); } }); } else { if(html5QrcodeScanner) html5QrcodeScanner.clear(); r.style.display='none'; } }
        function uploadExcel(input) { const fd=new FormData(); fd.append("file", input.files[0]); fetch(`${API}/products/upload`,{method:'POST',body:fd}).then(r=>r.text()).then(m=>{ alert(m); loadInventory(); }); }
        function downloadExcel() { window.location.href = `${API}/sales/export`; }
        function downloadReceipt(){ window.open(`/api/sales/${lastSaleId}/pdf`); }
        
        // üöÄ UPDATED: UX - IMMEDIATE FEEDBACK
        function shareReceipt(){ 
            const email = document.getElementById('shareEmail').value;
            if (!email) return alert("Please enter an email address.");
            const btn = event.target;
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check"></i> Sent!';
            btn.style.backgroundColor = '#10B981'; 
            btn.disabled = true;
            fetch(`${API}/sales/${lastSaleId}/share?email=${encodeURIComponent(email)}`, { method: 'POST' }).catch(e => console.warn(e));
            setTimeout(() => { btn.innerHTML = originalContent; btn.style.backgroundColor = ''; btn.disabled = false; alert(`‚úÖ Email request sent to ${email}`); }, 1500);
        }

        function printThermal(){ document.getElementById('receipt-date').innerText=new Date().toLocaleDateString().split(',')[0]; document.getElementById('receipt-id').innerText=lastSaleId; document.getElementById('receipt-cashier').innerText=document.getElementById('cashierName').value; document.getElementById('receipt-total').innerText=document.getElementById('cartTotal').innerText; document.getElementById('receipt-items-list').innerHTML=cart.map((i, idx)=>`<tr><td style="text-align:center;">${idx+1}</td><td>${i.name}</td><td style="text-align:right;">${i.price}</td><td style="text-align:center;">${i.quantity}</td><td style="text-align:right;">${(i.price*i.quantity).toFixed(2)}</td></tr>`).join(''); window.print(); }
        function filterInventory() { const term = document.getElementById('inventorySearch').value.toLowerCase(); document.querySelectorAll('#inventoryTable tr').forEach(row => { row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none'; }); }
        function detectProductDetails() { const name = document.getElementById('prodName').value.toLowerCase(); const match = [{k:'iphone',b:'Apple',c:'Electronics'}, {k:'nike',b:'Nike',c:'Apparel'}].find(r => name.includes(r.k)); if(match) { document.getElementById('prodBrand').value = match.b; document.getElementById('prodCategory').value = match.c; } }
        function toggleTheme() { document.body.classList.toggle('dark-mode'); const isDark = document.body.classList.contains('dark-mode'); const icon = document.getElementById('themeIcon'); if (isDark) { icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); icon.style.color = "#F59E0B"; } else { icon.classList.remove('fa-sun'); icon.classList.add('fa-moon'); icon.style.color = ""; } }
    </script>
</body>
</html>