<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SmartStore Manager Suite</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script> 
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- PRO THEME (INTER FONT + GLASSY LOOK) --- */
        :root { 
            --primary: #4F46E5;      /* Indigo */
            --primary-dark: #4338ca;
            --secondary: #10B981;    /* Emerald */
            --danger: #EF4444;       /* Red */
            --warning: #F59E0B;      /* Amber */
            --dark: #1e293b;         /* Slate 800 */
            --light: #f1f5f9;        /* Slate 100 */
            --card-bg: #ffffff;
            --text-main: #334155;    /* Slate 700 */
            --text-muted: #64748b;   /* Slate 500 */
            --border: #e2e8f0;
        }

        body { font-family: 'Inter', sans-serif; background: var(--light); padding: 30px; color: var(--text-main); margin: 0; }
        
        /* --- UPDATED DASHBOARD LAYOUT --- */
        .grid-dashboard-top { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px; 
            margin-bottom: 20px; 
        }
        .grid-dashboard-bottom {
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 20px; 
            margin-bottom: 30px; 
        }

        .grid-main { display: grid; grid-template-columns: 1.6fr 1fr; gap: 30px; transition: all 0.3s ease; }
        
        /* Admin Full Width Mode */
        .admin-view .grid-main { grid-template-columns: 1fr; } 

        /* Modern Card Design */
        .card { 
            background: var(--card-bg); 
            padding: 25px; 
            border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        /* Stats Cards */
        .stat-card { position: relative; overflow: hidden; }
        .stat-card::before { content:''; position: absolute; top:0; left:0; width: 4px; height: 100%; }
        .stat-revenue::before { background: linear-gradient(to bottom, #10B981, #34D399); }
        .stat-orders::before { background: linear-gradient(to bottom, #4F46E5, #818CF8); }
        .stat-alerts::before { background: linear-gradient(to bottom, #EF4444, #F87171); }

        .stat h2 { font-size: 2.4em; margin: 10px 0 0; color: var(--dark); font-weight: 700; letter-spacing: -1px; }
        .stat h3 { text-transform: uppercase; font-size: 0.75em; letter-spacing: 1.5px; color: var(--text-muted); margin:0; font-weight: 600; }

        /* Headers & Inputs */
        h1 { color: var(--dark); font-weight: 800; letter-spacing: -0.5px; }
        h2 { color: var(--dark); font-weight: 700; letter-spacing: -0.5px; }
        h3 { margin-top: 0; color: var(--text-main); font-size: 1.1em; }
        
        input, select { 
            padding: 12px 15px; 
            border: 1px solid var(--border); 
            border-radius: 10px; 
            width: 100%; 
            box-sizing: border-box; 
            background: #f8fafc; 
            font-size: 0.95em; 
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }
        input:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        /* Buttons */
        button { 
            padding: 12px 20px; 
            border:none; 
            border-radius: 10px; 
            color:white; 
            font-weight:600; 
            cursor:pointer; 
            width:100%; 
            transition: all 0.2s; 
            font-size: 0.95em;
        }
        button:hover { opacity: 0.95; transform: translateY(-1px); }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--secondary); }
        
        /* Modern Table */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; } 
        th { 
            text-transform: uppercase; 
            font-size: 0.75em; 
            color: var(--text-muted); 
            padding: 15px; 
            text-align: left; 
            border-bottom: 2px solid var(--border);
            font-weight: 600;
        } 
        td { 
            background: #fff; 
            padding: 15px; 
            border-bottom: 1px solid var(--border); 
            vertical-align: middle; 
            font-size: 0.95em;
        }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #f8fafc; }

        /* Stock Health Bar */
        .progress-bg { background: #e2e8f0; height: 6px; width: 100%; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; border-radius: 3px; }
        
        /* Badges */
        .badge-pill { padding: 4px 12px; border-radius: 50px; font-size: 0.8em; font-weight: 600; display: inline-block; }
        .badge-stock-ok { background: #d1fae5; color: #065f46; }
        .badge-stock-low { background: #fee2e2; color: #991b1b; }

        /* Utils */
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .form-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px; }
        .hidden { display: none !important; }

        /* Specific Component Styles */
        .user-badge { 
            background: #fff; border: 1px solid var(--border); 
            padding: 8px 16px; border-radius: 30px; 
            color: var(--dark); font-weight: 600; font-size: 0.9em; 
            display:flex; align-items:center; gap:10px; box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .search-bar-container { position: relative; width: 300px; }
        .search-bar-container i { position: absolute; left: 15px; top: 14px; color: #94a3b8; }
        .search-bar-container input { padding-left: 40px; }

        .btn-icon { width: 36px; height: 36px; border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; padding: 0; margin-right: 5px; }

		/* ==========================================
		           üñ®Ô∏è THERMAL PRINTER MODE (FIXED)
		           ========================================== */
		        #thermal-receipt { display: none; } /* Hidden on screen */

		        @media print {
		            /* 1. Hide EVERYTHING else */
		            body * { visibility: hidden; height: 0; overflow: hidden; }
		            
		            /* 2. CRITICAL FIX: Force the receipt to display */
		            #thermal-receipt { 
		                display: block !important; /* <--- THIS WAS MISSING */
		                visibility: visible;
		                position: absolute;
		                left: 0;
		                top: 0;
		                width: 100%;
		                margin: 0;
		                padding: 0;
		                font-family: 'Courier New', monospace;
		                color: black;
		                background: white; /* Ensure background is white */
		                z-index: 9999; /* Force it to top */
		            }

		            /* 3. Ensure children are visible */
		            #thermal-receipt * { 
		                visibility: visible; 
		                height: auto; 
		                overflow: visible; 
		            }
		            
		            /* Clean up layout for print */
		            .receipt-header { text-align: center; margin-bottom: 10px; border-bottom: 1px dashed #000; padding-bottom: 5px; }
		            .receipt-item { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; }
		            .receipt-footer { text-align: center; margin-top: 10px; border-top: 1px dashed #000; padding-top: 5px; font-size: 10px; }
		            .receipt-bold { font-weight: bold; }
		            
		            /* Hide browser default header/footer if possible (optional) */
		            @page { margin: 0; size: auto; }
		        }
    </style>
</head>
<body id="mainBody">
    
    <div class="flex-between" style="margin-bottom: 30px;">
        <div>
            <h1 style="margin:0;"><i class="fa-solid fa-cube" style="color:var(--primary);"></i> SmartStore</h1>
            <span style="color:var(--text-muted); font-size:0.9em; font-weight:500;">Enterprise Management Suite</span>
        </div>
        
        <div class="header-controls" style="display:flex; gap:12px; align-items:center;">
            <div id="adminControls" style="display:flex; gap:10px; align-items:center; background: #fff; padding: 5px; border-radius: 12px; border: 1px solid var(--border);">
                <input type="date" id="filterStart" onchange="loadDashboard()" style="border:none; background:transparent; width:auto; padding:5px 10px;">
                <span style="color:#ccc">|</span>
                <input type="date" id="filterEnd" onchange="loadDashboard()" style="border:none; background:transparent; width:auto; padding:5px 10px;">
            </div>
            
            <button id="exportBtn" onclick="downloadExcel()" class="btn-success" style="width:auto; padding: 10px 20px;"><i class="fa-solid fa-file-excel"></i> Export Report</button>

            <div class="user-badge">
                <div style="width:8px; height:8px; background:var(--secondary); border-radius:50%;"></div>
                <span id="currentUserDisplay">Loading...</span>
            </div>
            <input type="hidden" id="cashierName"> 
            
            <a href="/logout" style="text-decoration:none;">
                <button style="background:var(--dark); width:auto; padding: 10px 15px;"><i class="fa-solid fa-power-off"></i></button>
            </a>
        </div>
    </div>

    <div id="dashboardSection">
        
        <div class="grid-dashboard-top">
            <div class="card stat-card stat-revenue">
                <h3>Total Revenue</h3>
                <h2 id="statRevenue">$0.00</h2>
                <div style="margin-top:10px; font-size:0.85em; color:var(--secondary); font-weight:600;"><i class="fa-solid fa-arrow-trend-up"></i> Live Updates</div>
            </div>
            <div class="card stat-card stat-orders">
                <h3>Total Orders</h3>
                <h2 id="statOrders">0</h2>
                <div style="margin-top:10px; font-size:0.85em; color:var(--primary); font-weight:600;"><i class="fa-solid fa-receipt"></i> Processed</div>
            </div>
            <div class="card stat-card stat-alerts">
                <h3>Stock Alerts</h3>
                <h2 id="statLowStock">0</h2>
                <div style="margin-top:10px; font-size:0.85em; color:var(--danger); font-weight:600;"><i class="fa-solid fa-triangle-exclamation"></i> Action Needed</div>
            </div>
            
            <div class="card stat-card" style="background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white;">
                <h3 style="color: rgba(255,255,255,0.9); margin-bottom:5px;">AI Forecast</h3>
                <div style="font-size:0.8em; opacity:0.8; margin-bottom:5px;">Next 7 Days</div>
                <h2 id="statPrediction" style="color:white; margin:0;">0 Units</h2>
                <div style="margin-top:10px; font-size:0.85em; font-weight:600;">
                    <i class="fa-solid fa-robot"></i> ML Powered
                </div>
            </div>
        </div>

        <div class="grid-dashboard-bottom">
            <div class="card">
                <h3 style="margin-bottom:15px;">Sales Activity</h3>
                <div style="height:250px;">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h3 style="margin-bottom:15px;">Best Sellers</h3>
                <div style="height:250px; display:flex; justify-content:center;">
                    <canvas id="productsChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom:15px;">üèÜ VIP Customers</h3>
                <table style="margin-top:0;">
                    <tbody id="vipTable">
                        <tr><td style="color:var(--text-muted); text-align:center;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <div class="grid-main">
        
        <div class="card" id="inventorySection">
            <div class="flex-between" style="margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid var(--border);">
                <h2 style="margin:0;"><i class="fa-solid fa-boxes-stacked" style="color:var(--text-muted); margin-right:10px;"></i> Inventory Master</h2>
                
                <div class="search-bar-container">
                    <i class="fa-solid fa-search"></i>
                    <input type="text" id="inventorySearch" placeholder="Search products..." onkeyup="filterInventory()">
                </div>
            </div>

            <input type="hidden" id="prodId"> 
            <div style="background: #f8fafc; padding:20px; border-radius:12px; border:1px solid var(--border); margin-bottom:20px;">
                <div class="form-row">
                    <div>
                        <label style="font-size:0.8em; font-weight:600; color:var(--text-muted); margin-bottom:5px; display:block;">Product Name</label>
                        <input type="text" id="prodName" placeholder="e.g. iPhone 15" onkeyup="detectProductDetails()">
                    </div>
                    <div>
                        <label style="font-size:0.8em; font-weight:600; color:var(--text-muted); margin-bottom:5px; display:block;">Brand</label>
                        <input type="text" id="prodBrand" placeholder="Auto-Detect">
                    </div>
                    <div>
                        <label style="font-size:0.8em; font-weight:600; color:var(--text-muted); margin-bottom:5px; display:block;">Category</label>
                        <input type="text" id="prodCategory" placeholder="Auto-Detect">
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label style="font-size:0.8em; font-weight:600; color:var(--text-muted); margin-bottom:5px; display:block;">Price ($)</label>
                        <input type="number" id="prodPrice" step="0.01">
                    </div>
                    <div>
                        <label style="font-size:0.8em; font-weight:600; color:var(--text-muted); margin-bottom:5px; display:block;">Discount (%)</label>
                        <input type="number" id="prodDiscount">
                    </div>
                    <div>
                        <label style="font-size:0.8em; font-weight:600; color:var(--text-muted); margin-bottom:5px; display:block;">Initial Stock</label>
                        <input type="number" id="prodStock">
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button id="saveBtn" class="btn-primary" onclick="saveProduct()"><i class="fa-solid fa-plus"></i> Add to Inventory</button>
                    <button id="cancelBtn" onclick="resetForm()" style="background: var(--text-muted); width: 20%; display:none;">Cancel</button>
                </div>
            </div>

            <table style="width:100%">
                <thead>
                    <tr>
                        <th width="10%">ID</th>
                        <th width="30%">Product</th>
                        <th width="15%">Price</th>
                        <th width="25%">Stock Health</th> <th width="20%" style="text-align:right;">Actions</th>
                    </tr>
                </thead>
                <tbody id="inventoryTable"></tbody>
            </table>
        </div>

        <div class="card" id="billingSection">
            <div style="background: var(--dark); margin: -25px -25px 20px -25px; padding: 20px; border-radius: 16px 16px 0 0; color:white; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <h2 style="margin:0; color:white; font-size:1.2em;"><i class="fa-solid fa-cash-register"></i> POS Terminal</h2>
                    <div style="background:rgba(255,255,255,0.1); padding:5px 12px; border-radius:20px; font-size:0.85em; border:1px solid rgba(255,255,255,0.2);">
                        <i class="fa-regular fa-calendar"></i> <span id="posDateDisplay">Loading...</span>
                    </div>
                </div>
                <div style="font-size:0.85em; opacity:0.8; color:#4ade80;"><i class="fa-solid fa-wifi"></i> Connected</div>
            </div>
            
            <div id="reader" style="display:none; border-radius:10px; overflow:hidden; margin-bottom:15px;"></div>
            
            <button class="btn-primary" onclick="toggleScanner()" style="background: #8B5CF6; margin-bottom:15px;">
                <i class="fa-solid fa-qrcode"></i> Scan Product QR
            </button>

            <div style="display:grid; grid-template-columns: 2fr 1fr auto; gap:10px; margin-bottom:15px;">
                <select id="saleProductSelect"></select>
                <input type="number" id="saleQty" value="1" placeholder="Qty">
                <button onclick="addToCart()" class="btn-primary" style="width:auto;"><i class="fa-solid fa-plus"></i></button>
            </div>
            
            <div style="min-height: 200px; max-height:300px; overflow-y:auto;">
                <table style="margin-top:0;">
                    <thead><tr><th>Item</th><th style="text-align:center;">Qty</th><th style="text-align:right;">Total</th><th style="text-align:center;">X</th></tr></thead>
                    <tbody id="cartTable"></tbody>
                </table>
            </div>
            
            <div style="border-top: 2px dashed var(--border); margin-top:20px; padding-top:20px;">
                <div class="flex-between" style="margin-bottom:15px;">
                    <span style="font-weight:600; color:var(--text-muted);">Grand Total</span>
                    <span style="font-size:1.8em; font-weight:800; color:var(--dark);">$<span id="cartTotal">0.00</span></span>
                </div>

                <div style="margin-bottom:15px;">
                    <label style="font-size:0.8em; font-weight:600; color:var(--text-muted);">Customer Loyalty (Phone)</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="custPhone" placeholder="Enter Phone Number (e.g. 9876543210)">
                        <div style="padding:10px; background:#e0e7ff; color:var(--primary); border-radius:8px; font-size:0.9em; font-weight:bold; white-space:nowrap;">
                            <i class="fa-solid fa-star"></i> Points
                        </div>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                    <select id="payMethod"><option>Cash</option><option>UPI</option><option>Card</option></select>
                    <select id="payStatus"><option>Paid</option><option>Pending</option></select>
                </div>

                <button id="btnCheckout" class="btn-success" onclick="checkout()" style="padding:15px; font-size:1.1em;">
                    Complete Transaction <i class="fa-solid fa-arrow-right" style="margin-left:5px;"></i>
                </button>
                
                <div id="postSale" class="hidden" style="text-align:center; padding:20px; background:#f0fdf4; border-radius:12px; border:1px solid #bbf7d0; margin-top:15px;">
                    <div style="color:var(--secondary); font-size:3em; margin-bottom:10px;"><i class="fa-solid fa-circle-check"></i></div>
                    <h3 style="margin:0 0 10px 0; color:#15803d;">Sale Confirmed!</h3>
                    
                    <div style="display:flex; gap:10px; justify-content:center;">
                        <button onclick="downloadReceipt()" style="background:#15803d; width:auto;"><i class="fa-solid fa-download"></i> PDF</button>
                        <button onclick="printThermal()" style="background:#0f172a; width:auto;"><i class="fa-solid fa-print"></i> Thermal</button>
                        <button onclick="startNewSale()" style="background:var(--text-muted); width:auto;">New Sale</button>
                    </div>

                    <div style="margin-top:15px; display:flex; gap:5px;">
                        <input type="email" id="custEmail" placeholder="customer@email.com">
                        <button onclick="sendEmail()" style="width:auto; background:var(--primary);">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="thermal-receipt">
        <div class="receipt-header">
            <h2 style="margin:0;">SMARTSTORE</h2>
            <div>POS Terminal #1</div>
            <div id="receipt-date">Date: --/--/----</div>
            <div>Sale ID: <span id="receipt-id">#000</span></div>
        </div>
        
        <div id="receipt-items-list" style="margin: 10px 0;">
            </div>

        <div style="border-top: 1px dashed #000; padding-top: 5px; display:flex; justify-content:space-between; font-weight:bold;">
            <span>TOTAL</span>
            <span id="receipt-total">$0.00</span>
        </div>
        
        <div class="receipt-footer">
            <p>Thank you for shopping!</p>
            <p>No Returns without Receipt</p>
            <p>www.smartstore.app</p>
        </div>
    </div>

    <script>
        const API = '/api'; 
        let products = [], cart = [], lastSaleId = null, myChart = null;
        let html5QrcodeScanner = null;
        
        document.addEventListener('DOMContentLoaded', () => { 
            loadCurrentUser(); 
            setPosDate(); // Initialize Date
        });

        // --- ROLE & LAYOUT LOGIC ---
        function loadCurrentUser() {
            fetch('/api/me').then(res => res.json()).then(data => {
                document.getElementById('currentUserDisplay').innerText = data.username + " (" + (data.role || 'Staff') + ")";
                document.getElementById('cashierName').value = data.username; 
                applyRolePermissions(data.role);
            });
        }

        function applyRolePermissions(role) {
            const body = document.getElementById('mainBody');
            const dashboardSection = document.getElementById('dashboardSection');
            const inventorySection = document.getElementById('inventorySection');
            const billingSection = document.getElementById('billingSection');
            const adminControls = document.getElementById('adminControls');
            const exportBtn = document.getElementById('exportBtn'); // Get Export Button

            if (role === 'ADMIN') {
                // ADMIN MODE: Full Width Dashboard & Inventory
                console.log("Mode: ADMIN");
                body.classList.add('admin-view'); // Triggers CSS to make grid 1 column
                if(billingSection) billingSection.remove(); // Completely remove billing to fix layout
                
                loadDashboard(); 
                loadInventory(); 

            } else {
                // CASHIER MODE: Billing Terminal Only
                console.log("Mode: CASHIER");
                if(dashboardSection) dashboardSection.remove();
                if(inventorySection) inventorySection.remove();
                if(adminControls) adminControls.remove();
                
                // üö® SECURITY: Remove Export Button
                if(exportBtn) exportBtn.remove(); 

                loadInventory(); // Need products for dropdown
                
                // Center the billing terminal
                document.querySelector('.grid-main').style.gridTemplateColumns = '1fr';
                document.querySelector('.grid-main').style.maxWidth = '600px';
                document.querySelector('.grid-main').style.margin = '0 auto';
            }
        }

        // --- POS DATE LOGIC ---
        function setPosDate() {
            const dateDisplay = document.getElementById('posDateDisplay');
            if(dateDisplay) {
                const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                dateDisplay.innerText = new Date().toLocaleDateString('en-US', options);
            }
        }

        // --- DASHBOARD (UPDATED) ---
        function loadDashboard() {
            const start = document.getElementById('filterStart').value;
            const end = document.getElementById('filterEnd').value;
            const url = start && end ? `${API}/dashboard/stats?startDate=${start}&endDate=${end}` : `${API}/dashboard/stats`;
            
            fetch(url).then(res => res.json()).then(stats => {
                document.getElementById('statRevenue').innerText = '$' + (stats.totalRevenue || 0).toFixed(2);
                document.getElementById('statOrders').innerText = stats.totalOrders || 0;
                document.getElementById('statLowStock').innerText = stats.lowStockCount || 0;
                
                // üß† UPDATE AI CARD
                document.getElementById('statPrediction').innerText = (stats.predictedSales || 0) + " Units";

                // Initialize BOTH charts
                initCharts(stats.totalOrders, stats.lowStockCount, stats.topProducts);

                // Render VIP Table
                const vipTable = document.getElementById('vipTable');
                if(stats.topCustomers && stats.topCustomers.length > 0) {
                    vipTable.innerHTML = stats.topCustomers.map((c, i) => `
                        <tr>
                            <td style="padding:10px 5px;">
                                <div style="font-weight:600; color:var(--dark);">
                                    ${i+1}. ${c.name || 'Unknown'}
                                </div>
                                <div style="font-size:0.8em; color:var(--text-muted);">${c.phone}</div>
                            </td>
                            <td style="text-align:right; font-weight:bold; color:var(--primary);">
                                <i class="fa-solid fa-star" style="font-size:0.8em;"></i> ${c.points}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    vipTable.innerHTML = '<tr><td colspan="2" style="text-align:center; color:#ccc;">No Data</td></tr>';
                }
            });
        }

        let salesChartRef = null;
        let productChartRef = null;

        function initCharts(orders, alerts, topProducts) {
            // 1. Bar Chart (Activity)
            const ctx1 = document.getElementById('salesChart').getContext('2d');
            if (salesChartRef) salesChartRef.destroy();
            salesChartRef = new Chart(ctx1, { 
                type: 'bar', 
                data: { 
                    labels: ['Total Orders', 'Stock Alerts'], 
                    datasets: [{ 
                        label: 'Count', 
                        data: [orders, alerts], 
                        backgroundColor: ['#4F46E5', '#EF4444'], 
                        borderRadius: 6,
                        barThickness: 50
                    }] 
                }, 
                options: { 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                } 
            });

            // 2. Pie Chart (Best Sellers)
            const ctx2 = document.getElementById('productsChart').getContext('2d');
            if (productChartRef) productChartRef.destroy();
            
            // Prepare Data from Map
            const labels = Object.keys(topProducts || {});
            const data = Object.values(topProducts || {});
            
            productChartRef = new Chart(ctx2, { 
                type: 'doughnut', // 'doughnut' looks more modern than 'pie'
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        data: data, 
                        backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'], 
                        borderWidth: 0
                    }] 
                }, 
                options: { 
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'bottom', labels: { boxWidth: 10, font: {size: 11} } } 
                    }
                } 
            });
        }

        // --- INVENTORY MASTER ---
        function loadInventory() { fetch(`${API}/products`).then(r=>r.json()).then(d=>{ products=d; renderInv(); renderDrop(); }); }
        
        function renderInv() { 
            const t = document.getElementById('inventoryTable'); 
            if(!t) return;
            t.innerHTML=''; 
            
            products.forEach(p => { 
                // üß† SMART STOCK LOGIC (Use DB minStock or default to 5)
                let limit = p.minStock || 5; 
                let stockColor = '#10B981'; // Green
                let statusText = 'Good';
                let safeZone = limit * 2; 
                let percent = Math.min((p.stock / safeZone) * 100, 100) + '%';

                if(p.stock <= limit) {
                    stockColor = '#EF4444'; // Red
                    statusText = 'Low Stock';
                } else if(p.stock <= (limit + 2)) {
                    stockColor = '#F59E0B'; // Orange
                    statusText = 'Warning';
                }

                t.innerHTML += `<tr>
                    <td style="font-family:monospace; color:var(--primary); font-weight:600;">PRD-${String(p.id).padStart(3, '0')}</td>
                    <td>
                        <div style="font-weight:600; color:var(--dark);">${p.name}</div>
                        <div style="font-size:0.8em; color:var(--text-muted);">${p.brand || 'Generic'} ‚Ä¢ ${p.category || 'General'}</div>
                    </td>
                    <td style="font-weight:600;">$${p.price.toFixed(2)}</td>
                    <td>
                        <div style="display:flex; justify-content:space-between; font-size:0.8em; margin-bottom:2px;">
                            <span>${p.stock} units</span>
                            <span style="color:${stockColor}; font-weight:bold;">${statusText}</span>
                        </div>
                        <div class="progress-bg"><div class="progress-fill" style="width:${percent}; background:${stockColor};"></div></div>
                         <div style="font-size:0.7em; color:#94a3b8; text-align:right; margin-top:2px;">Min: ${limit}</div>
                    </td>
                    <td style="text-align:right;">
                        <button class="btn-icon" style="background:#F59E0B;" onclick="editProduct(${p.id})"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn-icon" style="background:#EF4444;" onclick="deleteProduct(${p.id})"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`; 
            }); 
        }

        // Client-Side Filter
        function filterInventory() {
            const term = document.getElementById('inventorySearch').value.toLowerCase();
            const rows = document.querySelectorAll('#inventoryTable tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        }

        function detectProductDetails() {
            const name = document.getElementById('prodName').value.toLowerCase();
            const match = [{k:'iphone',b:'Apple',c:'Electronics'}, {k:'milk',b:'Dairy',c:'Groceries'}, {k:'nike',b:'Nike',c:'Apparel'}]
                .find(r => name.includes(r.k));
            if(match) {
                document.getElementById('prodBrand').value = match.b; 
                document.getElementById('prodCategory').value = match.c;
            }
        }
        function editProduct(id) {
            const p = products.find(x => x.id === id);
            document.getElementById('prodId').value = p.id;
            document.getElementById('prodName').value = p.name;
            document.getElementById('prodBrand').value = p.brand;
            document.getElementById('prodCategory').value = p.category;
            document.getElementById('prodPrice').value = p.price;
            document.getElementById('prodDiscount').value = p.discount;
            document.getElementById('prodStock').value = p.stock;
            document.getElementById('saveBtn').innerHTML = '<i class="fa-solid fa-check"></i> Update';
            document.getElementById('cancelBtn').style.display = 'block';
        }
        function resetForm() {
            document.getElementById('prodId').value = '';
            document.querySelectorAll('.form-row input').forEach(i => i.value=''); 
            document.getElementById('saveBtn').innerHTML = '<i class="fa-solid fa-plus"></i> Add to Inventory';
            document.getElementById('cancelBtn').style.display = 'none';
        }
        function saveProduct() { 
             const id = document.getElementById('prodId').value;
             const product = { 
                 name: document.getElementById('prodName').value, 
                 brand: document.getElementById('prodBrand').value, 
                 category: document.getElementById('prodCategory').value, 
                 price: parseFloat(document.getElementById('prodPrice').value), 
                 discount: parseFloat(document.getElementById('prodDiscount').value)||0, 
                 stock: parseInt(document.getElementById('prodStock').value) 
             };
             const method = id ? 'PUT' : 'POST';
             const url = id ? `${API}/products/${id}` : `${API}/products`;
             fetch(url, { method: method, headers:{'Content-Type':'application/json'}, body:JSON.stringify(product)})
                .then(() => { resetForm(); loadInventory(); });
        }
        function deleteProduct(id) { if(confirm("Delete item?")) fetch(`${API}/products/${id}`, {method:'DELETE'}).then(loadInventory); }
        function renderDrop() { 
            const s = document.getElementById('saleProductSelect');
            if(s) s.innerHTML = products.filter(p=>p.stock>0).map(p=>`<option value="${p.id}">${p.name} ($${p.price})</option>`).join(''); 
        }

        // --- BILLING LOGIC ---
        function addToCart(pidDirect=null) { 
            let pid = pidDirect && typeof pidDirect === 'object' ? pidDirect.id : (pidDirect || parseInt(document.getElementById('saleProductSelect').value));
            let p = products.find(x => x.id === pid);
            let qtyInput = document.getElementById('saleQty');
            let qtyToAdd = pidDirect && typeof pidDirect === 'object' ? 1 : (qtyInput ? parseInt(qtyInput.value) : 1);
            
            if(!p) return alert("Product not found");
            if(p.stock < qtyToAdd) return alert("Low Stock!");
            
            let item = cart.find(i => i.productId === pid);
            if(item) item.quantity += qtyToAdd;
            else cart.push({productId: pid, name: p.name, price: p.price, quantity: qtyToAdd});
            renderCart();
        }
        function removeFromCart(i) { cart.splice(i, 1); renderCart(); }
        function renderCart() { 
            document.getElementById('cartTable').innerHTML = cart.map((i, idx) => `
                <tr>
                    <td>${i.name}</td><td style="text-align:center;">${i.quantity}</td>
                    <td style="text-align:right;">$${(i.price*i.quantity).toFixed(2)}</td>
                    <td style="text-align:center; color:var(--danger); cursor:pointer;" onclick="removeFromCart(${idx})"><i class="fa-solid fa-times"></i></td>
                </tr>`).join('');
            document.getElementById('cartTotal').innerText = cart.reduce((a,b)=>a+(b.price*b.quantity),0).toFixed(2);
        }
        function checkout() { 
            const cashier = document.getElementById('cashierName').value;
            // üö® GET PHONE NUMBER FROM INPUT
            const phone = document.getElementById('custPhone').value; 

            if(cart.length === 0) return alert("Cart Empty");
            fetch(`${API}/sales`, {
                method:'POST', headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({ 
                    items:cart, 
                    cashierName: cashier, 
                    paymentMethod: document.getElementById('payMethod').value, 
                    status: document.getElementById('payStatus').value,
                    customerPhone: phone // üëà SEND PHONE TO BACKEND
                })
            }).then(r=>r.json()).then(d=>{ 
                lastSaleId=d.id; 
                document.getElementById('btnCheckout').classList.add('hidden'); 
                document.getElementById('postSale').classList.remove('hidden'); 
                loadInventory(); loadDashboard();
                
                // Reset phone for next customer
                document.getElementById('custPhone').value = '';
            });
        }
        function downloadExcel() { window.open(`${API}/sales/export`, '_blank'); }
        function downloadReceipt() { window.open(`${API}/sales/${lastSaleId}/pdf`, '_blank'); }
        function sendEmail() { 
            const email = document.getElementById('custEmail').value;
            const btn = event.target; btn.innerText="Sending...";
            fetch(`${API}/sales/${lastSaleId}/email?email=${email}`, {method:'POST'}).then(r=> {
                if(r.ok) alert("Sent!"); else alert("Error");
                btn.innerText="Send";
            });
        }
        function startNewSale() { 
            lastSaleId=null; cart=[]; renderCart(); 
            document.getElementById('postSale').classList.add('hidden'); 
            document.getElementById('btnCheckout').classList.remove('hidden'); 
        }

        // --- SCANNER ---
        function toggleScanner() {
            const r = document.getElementById('reader');
            if (r.style.display === 'none') {
                r.style.display = 'block';
                html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
                html5QrcodeScanner.render((txt) => {
                    let p = products.find(x => x.name.toLowerCase()===txt.toLowerCase() || x.id==txt);
                    if(p) { addToCart(p); html5QrcodeScanner.pause(); setTimeout(()=>html5QrcodeScanner.resume(), 1500); }
                });
            } else {
                if(html5QrcodeScanner) html5QrcodeScanner.clear();
                r.style.display = 'none';
            }
        }
        
        // üñ®Ô∏è THERMAL PRINT FUNCTION
        function printThermal() {
            // 1. Fill Header Info
            document.getElementById('receipt-date').innerText = new Date().toLocaleString();
            document.getElementById('receipt-id').innerText = lastSaleId || "PENDING";
            document.getElementById('receipt-total').innerText = document.getElementById('cartTotal').innerText;

            // 2. Fill Items
            const list = document.getElementById('receipt-items-list');
            list.innerHTML = '';
            cart.forEach(item => {
                list.innerHTML += `
                    <div class="receipt-item">
                        <span>${item.name} x${item.quantity}</span>
                        <span>$${(item.price * item.quantity).toFixed(2)}</span>
                    </div>
                `;
            });

            // 3. Trigger Browser Print
            window.print(); 
        }
		
		// ==========================================
		// üöÄ PRO UPGRADE: KEYBOARD SHORTCUTS (HOTKEYS)
		// ==========================================
		document.addEventListener('keydown', function(event) {
		            
		    // F2: Focus on Product Search / Selector
		    if (event.key === 'F2') {
		        event.preventDefault(); // Stop browser default
		        document.getElementById('saleProductSelect').focus();
		        showToast("‚å®Ô∏è F2: Ready to Scan");
		    }

		    // ENTER: Add to Cart (Only if we are not in the main search bar)
		    if (event.key === 'Enter') {
		        const activeId = document.activeElement.id;
		        if (activeId !== 'inventorySearch' && activeId !== 'custPhone') {
		            event.preventDefault();
		            addToCart();
		            document.getElementById('saleQty').select(); 
		        }
		    }

		    // F9: Checkout / Pay
		    if (event.key === 'F9') {
		        event.preventDefault();
		        if(cart.length > 0) {
		            checkout();
		            showToast("‚å®Ô∏è F9: Processing Sale...");
		        } else {
		            alert("Cart is empty!");
		        }
		    }

		    // ESC: Clear Cart / New Customer
		    if (event.key === 'Escape') {
		        event.preventDefault();
		        if(confirm("‚å®Ô∏è ESC: Clear current cart and start over?")) {
		            startNewSale();
		            showToast("Cart Cleared");
		        }
		    }
		});

		// Simple "Toast" notification for professional feedback
		function showToast(msg) {
		    const div = document.createElement('div');
		    div.style = "position:fixed; bottom:20px; right:20px; background:#333; color:white; padding:10px 20px; border-radius:5px; z-index:9999; animation: fadein 0.5s, fadeout 0.5s 2.5s;";
		    div.innerText = msg;
		    document.body.appendChild(div);
		    setTimeout(() => div.remove(), 3000);
		}
		
    </script>
</body>
</html>