<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SmartStore Manager Suite</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script> 
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- MODERN SLATE THEME --- */
        :root { 
            --primary: #2c3e50;      /* Dark Blue-Grey */
            --accent: #2980b9;       /* Bright Blue */
            --success: #27ae60;      /* Green */
            --warning: #f39c12;      /* Orange (Edit) */
            --danger: #c0392b;       /* Red */
            --bg-body: #dfe4ea;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-muted: #7f8c8d;
        }
        body { font-family: 'Segoe UI', 'Roboto', sans-serif; background: var(--bg-body); padding: 25px; color: var(--text-main); margin: 0; }
        .card { background: var(--card-bg); padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .grid-dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .grid-main { display: grid; grid-template-columns: 1.5fr 1fr; gap: 25px; }
        .form-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px; }
        .stat h2 { font-size: 2.2em; margin: 5px 0 0; color: var(--primary); font-weight: 700; }
        .stat h3 { text-transform: uppercase; font-size: 0.8em; letter-spacing: 1.5px; color: var(--text-muted); margin:0; font-weight: 600; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; } 
        th { text-transform: uppercase; font-size: 0.8em; color: var(--text-muted); padding: 10px 15px; text-align: left; } 
        td { background: #f8f9fa; padding: 15px; border-top: 1px solid #e1e8ee; border-bottom: 1px solid #e1e8ee; vertical-align: middle; }
        td:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; border-left: 1px solid #e1e8ee; font-family: 'Consolas', monospace; color: var(--accent); font-weight: bold; }
        td:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; border-right: 1px solid #e1e8ee; text-align: right;}
        input, select { padding: 12px; border: 1px solid #dcdde1; border-radius: 8px; width: 100%; box-sizing: border-box; background: #fdfdfd; font-size: 0.95em; }
        input:focus { outline: none; border-color: var(--accent); }
        button { padding: 12px; border:none; border-radius: 8px; color:white; font-weight:bold; cursor:pointer; width:100%; margin-top:5px; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:active { transform: translateY(1px); }
        .hidden { display: none; }
        .auto-filled { background-color: #e8f8f5; border-color: var(--success); }
        .stock-badge { padding: 4px 10px; border-radius: 6px; font-weight: bold; font-size: 0.85em; }
        .stock-ok { background: #e8f5e9; color: #2e7d32; }
        .stock-low { background: #ffebee; color: #c62828; }
        .btn-edit { background: var(--warning); width: 35px; height: 35px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 5px; padding: 0;}
        .btn-delete { background: var(--danger); width: 35px; height: 35px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; padding: 0;}
        .btn-scan { background: #8e44ad; margin-bottom: 10px; }
        #reader { width: 100%; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 8px; overflow: hidden; }
        .btn-logout { background-color: var(--danger); width: auto; padding: 8px 15px; font-size: 0.9em; margin: 0;}
        .user-badge { background: white; padding: 8px 15px; border-radius: 20px; color: var(--primary); font-weight: bold; border: 1px solid #dcdde1; font-size: 0.9em; display:flex; align-items:center; gap:8px;}
        .header-controls { display:flex; gap:10px; align-items:center; }
        .header-controls input { width: auto; margin: 0; padding: 8px;}
        .header-controls button { width: auto; margin: 0; padding: 8px 15px; font-size: 0.9em;}
    </style>
</head>
<body>
    <div class="flex-between" style="margin-bottom: 25px;">
        <h1 style="color: var(--primary); margin:0; font-size: 1.8em;"><i class="fa-solid fa-cube"></i> SmartStore <span style="font-weight:300;">Suite</span></h1>
        <div class="header-controls">
            <input type="date" id="filterStart" onchange="loadDashboard()">
            <span style="color:#999">-</span>
            <input type="date" id="filterEnd" onchange="loadDashboard()">
            <button onclick="downloadExcel()" style="background:#27ae60;"><i class="fa-solid fa-file-excel"></i> Export</button>
            <div class="user-badge"><i class="fa-solid fa-circle-user" style="color:var(--accent)"></i> <span id="currentUserDisplay">Loading...</span></div>
            <input type="hidden" id="cashierName"> 
            <a href="/logout"><button class="btn-logout"><i class="fa-solid fa-power-off"></i> Logout</button></a>
        </div>
    </div>

    <div class="grid-dashboard">
        <div class="card" style="border-left: 5px solid var(--success);"><h3>Total Revenue</h3><h2 id="statRevenue">$0.00</h2></div>
        <div class="card" style="border-left: 5px solid var(--accent);"><h3>Total Orders</h3><h2 id="statOrders">0</h2></div>
        <div class="card" style="border-left: 5px solid var(--danger);"><h3>Stock Alerts</h3><h2 id="statLowStock">0</h2></div>
        <div class="card" style="display:flex; justify-content:center; align-items:center;"><canvas id="salesChart" style="max-height:80px; width:100%;"></canvas></div>
    </div>

    <div class="grid-main">
        <div class="card">
            <div class="flex-between" style="margin-bottom:15px;">
                <h2 style="margin:0; font-size:1.3em;"><i class="fa-solid fa-boxes-stacked"></i> Inventory Master</h2>
            </div>
            <input type="hidden" id="prodId"> 
            <div class="form-row">
                <input type="text" id="prodName" placeholder="Product Name (e.g. iPhone)" onkeyup="detectProductDetails()">
                <input type="text" id="prodBrand" placeholder="Brand (Auto-Detect)">
                <input type="text" id="prodCategory" placeholder="Category (Auto-Detect)">
            </div>
            <div class="form-row">
                <input type="number" id="prodPrice" placeholder="Price ($)" step="0.01">
                <input type="number" id="prodDiscount" placeholder="Discount (%)">
                <input type="number" id="prodStock" placeholder="Stock Qty">
            </div>
            <div style="display:flex; gap:10px;">
                <button id="saveBtn" onclick="saveProduct()" style="background: var(--primary);"><i class="fa-solid fa-plus"></i> Save Product</button>
                <button id="cancelBtn" onclick="resetForm()" style="background: #95a5a6; width: 30%; display:none;">Cancel</button>
            </div>
            <table style="margin-top:20px;">
                <thead><tr><th>ID</th><th>Item Details</th><th>Price</th><th>Stock</th><th>Action</th></tr></thead>
                <tbody id="inventoryTable"></tbody>
            </table>
        </div>

        <div class="card">
            <h2 style="margin:0 0 15px 0; font-size:1.3em;"><i class="fa-solid fa-cash-register"></i> Billing Terminal</h2>
            <button class="btn-scan" onclick="toggleScanner()"><i class="fa-solid fa-barcode"></i> Toggle Scanner</button>
            <div id="reader" class="hidden"></div>

            <div style="display:grid; grid-template-columns: 1fr auto; gap:10px;">
                <select id="saleProductSelect"></select>
                <input type="number" id="saleQty" value="1" style="width:70px;">
            </div>
            <button onclick="addToCart()" style="background: var(--accent);">Add to Cart</button>
            
            <table style="margin-top:15px;">
                <thead><tr><th>Item</th><th>Qty</th><th>Total</th></tr></thead>
                <tbody id="cartTable"></tbody>
            </table>
            
            <div style="background:#f8f9fa; padding:10px; border-radius:8px; margin-top:10px; border:1px solid #eee;">
                <label style="font-size:0.85em; font-weight:bold; color:#7f8c8d;">PAYMENT DETAILS</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:5px;">
                    <select id="payMethod">
                        <option value="Cash">Cash</option>
                        <option value="Online (UPI)">Online (UPI)</option>
                        <option value="Card">Credit/Debit Card</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                    </select>
                    <select id="payStatus">
                        <option value="Paid">Paid</option>
                        <option value="Pending">Pending</option>
                        <option value="Due">Due</option>
                    </select>
                </div>
            </div>

            <h3 style="text-align:right; margin-top:20px; font-size:1.5em;">Total: $<span id="cartTotal">0.00</span></h3>
            <button id="btnCheckout" onclick="checkout()" style="background:#e67e22; font-size:1.1em; padding:15px;">Complete Sale</button>
            
            <div id="postSale" class="hidden" style="margin-top:15px; border-top:2px dashed #eee; padding-top:15px;">
                <p style="color:var(--success); font-weight:bold; text-align:center; margin:0 0 10px 0;"><i class="fa-solid fa-check-circle"></i> Transaction Successful</p>
                <button onclick="downloadReceipt()" style="background:var(--success); margin-bottom:10px;">Download Receipt PDF</button>
                <div style="display:grid; grid-template-columns: 1fr auto; gap:10px;">
                    <input type="email" id="custEmail" placeholder="Customer Email" style="margin:0;">
                    <button onclick="sendEmail()" style="width:auto; background:var(--primary);">Send</button>
                </div>
                <button onclick="startNewSale()" style="background:#95a5a6; margin-top:15px;">Start New Sale</button>
            </div>
        </div>
    </div>

    <script>
        const API = 'http://localhost:8090/api';
        let products = [], cart = [], lastSaleId = null, myChart = null;
        let html5QrcodeScanner = null;
        
        document.addEventListener('DOMContentLoaded', () => { 
            loadCurrentUser(); loadInventory(); loadDashboard(); 
        });

        function loadCurrentUser() {
            fetch('/api/me').then(res => res.json()).then(data => {
                document.getElementById('currentUserDisplay').innerText = data.username;
                document.getElementById('cashierName').value = data.username; 
            });
        }

        function loadDashboard() {
            const start = document.getElementById('filterStart').value;
            const end = document.getElementById('filterEnd').value;
            const url = start && end ? `${API}/dashboard/stats?startDate=${start}&endDate=${end}` : `${API}/dashboard/stats`;
            
            fetch(url).then(res => res.json()).then(stats => {
                document.getElementById('statRevenue').innerText = '$' + (stats.totalRevenue || 0).toFixed(2);
                document.getElementById('statOrders').innerText = stats.totalOrders || 0;
                document.getElementById('statLowStock').innerText = stats.lowStockCount || 0;
                const ctx = document.getElementById('salesChart').getContext('2d');
                if (myChart) myChart.destroy();
                myChart = new Chart(ctx, { type: 'bar', data: { labels: ['Orders', 'Alerts'], datasets: [{ label: 'Overview', data: [stats.totalOrders, stats.lowStockCount], backgroundColor: ['#3498db', '#e74c3c'], borderRadius: 5 }] }, options: {plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, grid:{display:false}}, x:{grid:{display:false}}}, maintainAspectRatio: false} });
            });
        }
        
        function detectProductDetails() {
            const name = document.getElementById('prodName').value.toLowerCase();
            const rules = [
                {k:'iphone',b:'Apple',c:'Electronics'}, {k:'samsung',b:'Samsung',c:'Electronics'}, {k:'dell',b:'Dell',c:'Computers'},
                {k:'milk',b:'Dairy',c:'Groceries'}, {k:'nike',b:'Nike',c:'Apparel'}, {k:'coke',b:'CocaCola',c:'Drinks'}
            ];
            const match = rules.find(r => name.includes(r.k));
            if(match) {
                const b = document.getElementById('prodBrand');
                const c = document.getElementById('prodCategory');
                b.value = match.b; c.value = match.c;
                b.classList.add('auto-filled'); c.classList.add('auto-filled');
                setTimeout(()=> { b.classList.remove('auto-filled'); c.classList.remove('auto-filled');}, 500);
            }
        }

        function loadInventory() { fetch(`${API}/products`).then(r=>r.json()).then(d=>{ products=d; renderInv(); renderDrop(); }); }
        
        function renderInv() { 
            const t = document.getElementById('inventoryTable'); t.innerHTML=''; 
            const padId = (n) => "PRD-" + String(n).padStart(4, '0');
            products.forEach(p => { 
                const stockBadge = p.stock < 5 ? `<span class="stock-badge stock-low">Low: ${p.stock}</span>` : `<span class="stock-badge stock-ok">${p.stock} In Stock</span>`;
                t.innerHTML += `<tr>
                    <td>${padId(p.id)}</td>
                    <td><div style="font-weight:bold;">${p.name}</div><div style="font-size:0.85em; color:#888;">${p.brand || '-'} &bull; ${p.category || '-'}</div></td>
                    <td>$${p.price.toFixed(2)}</td>
                    <td>${stockBadge}</td>
                    <td>
                        <button class="btn-edit" onclick="editProduct(${p.id})"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn-delete" onclick="deleteProduct(${p.id})"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`; 
            }); 
        }

        function editProduct(id) {
            const p = products.find(x => x.id === id);
            document.getElementById('prodId').value = p.id;
            document.getElementById('prodName').value = p.name;
            document.getElementById('prodBrand').value = p.brand;
            document.getElementById('prodCategory').value = p.category;
            document.getElementById('prodPrice').value = p.price;
            document.getElementById('prodDiscount').value = p.discount;
            document.getElementById('prodStock').value = p.stock;
            document.getElementById('saveBtn').innerHTML = '<i class="fa-solid fa-rotate"></i> Update Product';
            document.getElementById('saveBtn').style.background = "#f39c12"; 
            document.getElementById('cancelBtn').style.display = 'block';
        }

        function resetForm() {
            document.getElementById('prodId').value = '';
            document.querySelectorAll('.form-row input').forEach(i => i.value=''); 
            document.getElementById('saveBtn').innerHTML = '<i class="fa-solid fa-plus"></i> Save Product';
            document.getElementById('saveBtn').style.background = "#2c3e50"; 
            document.getElementById('cancelBtn').style.display = 'none';
        }

        function saveProduct() { 
             const id = document.getElementById('prodId').value;
             const product = { 
                 name: document.getElementById('prodName').value, 
                 brand: document.getElementById('prodBrand').value, 
                 category: document.getElementById('prodCategory').value, 
                 price: parseFloat(document.getElementById('prodPrice').value), 
                 discount: parseFloat(document.getElementById('prodDiscount').value)||0, 
                 stock: parseInt(document.getElementById('prodStock').value) 
             };
             const method = id ? 'PUT' : 'POST';
             const url = id ? `${API}/products/${id}` : `${API}/products`;
             fetch(url, { method: method, headers:{'Content-Type':'application/json'}, body:JSON.stringify(product)})
                .then(() => { resetForm(); loadInventory(); });
        }
        function deleteProduct(id) { if(confirm("Are you sure?")) fetch(`${API}/products/${id}`, {method:'DELETE'}).then(loadInventory); }
        function renderDrop() { document.getElementById('saleProductSelect').innerHTML = products.filter(p=>p.stock>0).map(p=>`<option value="${p.id}">${p.name} ($${p.price})</option>`).join(''); }
        
        function addToCart(pidDirect=null) { 
            const pid = pidDirect || parseInt(document.getElementById('saleProductSelect').value);
            const p = products.find(x=>x.id===pid);
            if(!p) return alert("Product not found");
            if(p.stock < 1) return alert("Out of Stock!");
            
            const discount = p.discount || 0;
            const finalPrice = p.price - (p.price * discount / 100);
            
            const item = cart.find(i=>i.productId===pid);
            if(item) item.quantity += 1;
            else cart.push({productId:pid, name:p.name, price:finalPrice, quantity:1});
            renderCart();
        }

        function toggleScanner() { 
            const reader = document.getElementById('reader'); 
            if (reader.classList.contains('hidden')) { 
                reader.classList.remove('hidden'); 
                html5QrcodeScanner = new Html5Qrcode("reader"); 
                html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => { 
                    const id = parseInt(txt);
                    const p = products.find(x => x.id === id);
                    if(p) { addToCart(p.id); alert("Scanned: " + p.name); } 
                    else { alert("Product ID " + txt + " not found!"); }
                }, () => {}); 
            } else { 
                if(html5QrcodeScanner) html5QrcodeScanner.stop().then(() => reader.classList.add('hidden')); 
            } 
        }

        function renderCart() { 
            document.getElementById('cartTable').innerHTML = cart.map(i=>`<tr><td>${i.name}</td><td style="text-align:center;">${i.quantity}</td><td style="text-align:right;">$${(i.price*i.quantity).toFixed(2)}</td></tr>`).join('');
            document.getElementById('cartTotal').innerText = cart.reduce((a,b)=>a+(b.price*b.quantity),0).toFixed(2);
        }

        function checkout() { 
            const cashier = document.getElementById('cashierName').value;
            // Capture NEW Fields
            const method = document.getElementById('payMethod').value;
            const status = document.getElementById('payStatus').value;

            if(cart.length === 0) return alert("Cart is empty!");
            
            fetch(`${API}/sales`, {
                method:'POST', headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({
                    items:cart, 
                    cashierName: cashier,
                    paymentMethod: method, // Send to backend
                    status: status         // Send to backend
                })
            })
            .then(r=>r.json()).then(d=>{ 
                lastSaleId=d.id; 
                document.getElementById('btnCheckout').classList.add('hidden'); 
                document.getElementById('postSale').classList.remove('hidden'); 
                loadInventory(); loadDashboard();
            });
        }
        
        function downloadExcel() { window.open(`${API}/sales/export`, '_blank'); }
        function downloadReceipt() { window.open(`${API}/sales/${lastSaleId}/pdf`, '_blank'); }
        function sendEmail() { 
            const email = document.getElementById('custEmail').value;
            const btn = event.target; btn.innerHTML = "Sending..."; btn.disabled=true;
            fetch(`${API}/sales/${lastSaleId}/email?email=${email}`, {method:'POST'}).then(r=>{ 
                if(r.ok) alert("Email Sent Successfully!"); else alert("Failed to send. Check console."); 
                btn.innerHTML = "Send"; btn.disabled=false;
            });
        }
        function startNewSale() { lastSaleId=null; cart=[]; renderCart(); document.getElementById('postSale').classList.add('hidden'); document.getElementById('btnCheckout').classList.remove('hidden'); }
    </script>
</body>
</html>